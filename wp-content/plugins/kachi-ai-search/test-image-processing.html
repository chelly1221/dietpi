<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Processing Test</title>
</head>
<body>
    <h2>Image Processing Test</h2>
    <div id="test-output"></div>

    <script>
        // 테스트용 formatResponsePreservingImages 함수 (kachi-api.js에서 추출)
        function formatResponsePreservingImages(text) {
            // 이미 처리된 이미지 태그를 임시로 보호
            const imagePlaceholders = {};
            let imageCounter = 0;
            
            // 기존 이미지 태그 보호
            text = text.replace(/<img[^>]*>/g, function(match) {
                const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter++}__`;
                imagePlaceholders[placeholder] = match;
                return placeholder;
            });
            
            // 이미지 URL 패턴들을 마크다운 처리 전에 감지하여 보호
            // 1. 이중 URL 패턴: [http://...](http://...)
            text = text.replace(/\[\s*(https?:\/\/[^\s\]]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s\]]*)?[^\s\]]*)\s*\]\(\s*(https?:\/\/[^\s\)]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s\)]*)?[^\s\)]*)\s*\)/gi, function(match, url1, url2) {
                // 두 URL이 같거나 유사한 경우 이미지로 처리
                if (url1 === url2 || Math.abs(url1.length - url2.length) <= 3) {
                    const finalUrl = url1.length >= url2.length ? url1 : url2;
                    const proxyUrl = `http://192.168.10.101:8001/proxy-image?url=${encodeURIComponent(finalUrl)}`;
                    const imgTag = `<img src="${proxyUrl}" alt="Image" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" loading="lazy" onerror="this.style.display='none'">`;
                    
                    const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter++}__`;
                    imagePlaceholders[placeholder] = imgTag;
                    return placeholder;
                }
                return match; // URL이 다른 경우 원래 텍스트 유지
            });
            
            // 2. 일반 마크다운 이미지 패턴: ![alt](http://...)
            text = text.replace(/!\[([^\]]*)\]\(\s*(https?:\/\/[^\s\)]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s\)]*)?[^\s\)]*)\s*\)/gi, function(match, alt, url) {
                const proxyUrl = `http://192.168.10.101:8001/proxy-image?url=${encodeURIComponent(url)}`;
                const imgTag = `<img src="${proxyUrl}" alt="${alt || 'Image'}" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" loading="lazy" onerror="this.style.display='none'">`;
                
                const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter++}__`;
                imagePlaceholders[placeholder] = imgTag;
                return placeholder;
            });
            
            // 3. 단순 URL 패턴 (독립된 줄에 있는 경우)
            text = text.replace(/^\s*(https?:\/\/[^\s]+\.(?:jpg|jpeg|png|gif|webp|bmp|svg)(?:\?[^\s]*)?)\s*$/gmi, function(match, url) {
                const proxyUrl = `http://192.168.10.101:8001/proxy-image?url=${encodeURIComponent(url)}`;
                const imgTag = `<img src="${proxyUrl}" alt="Image" style="max-width: 100%; height: auto; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" loading="lazy" onerror="this.style.display='none'">`;
                
                const placeholder = `__IMAGE_PLACEHOLDER_${imageCounter++}__`;
                imagePlaceholders[placeholder] = imgTag;
                return placeholder;
            });
            
            // 기존 포맷팅 로직 적용 (이미지 처리 제외) - 간소화된 버전
            // **text** 패턴을 <strong>text</strong>으로 변환
            text = text.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
            
            // *text* 패턴도 <strong>text</strong>으로 변환 (single asterisk)
            text = text.replace(/(?<!\*)\*(?!\*)([^*]+)(?<!\*)\*(?!\*)/g, '<strong>$1</strong>');
            
            // 줄바꿈을 <br>로 변환
            text = text.replace(/\n/g, '<br>');
            
            // 이미지 플레이스홀더를 원래 태그로 복원
            let result = text;
            Object.keys(imagePlaceholders).forEach(placeholder => {
                result = result.replace(new RegExp(placeholder, 'g'), imagePlaceholders[placeholder]);
            });
            
            return result;
        }

        // 테스트 케이스들
        const testCases = [
            {
                name: "Double URL (같은 URL)",
                input: "[http://192.168.10.101:8001/images/03ff1bb5.jpg](http://192.168.10.101:8001/images/03ff1bb5.jpg)"
            },
            {
                name: "Regular Markdown Image",
                input: "![Sample Image](http://192.168.10.101:8001/images/sample.jpg)"
            },
            {
                name: "Plain URL",
                input: "http://192.168.10.101:8001/images/plain.png"
            },
            {
                name: "Mixed with other markdown",
                input: "**굵은 글씨** 와 [http://192.168.10.101:8001/images/mixed.jpg](http://192.168.10.101:8001/images/mixed.jpg) 그리고 *기울임* 글씨"
            },
            {
                name: "Multiple images",
                input: "첫 번째 이미지: ![image1](http://192.168.10.101:8001/images/img1.jpg)\n두 번째 이미지: [http://192.168.10.101:8001/images/img2.png](http://192.168.10.101:8001/images/img2.png)"
            }
        ];

        // 테스트 실행
        const output = document.getElementById('test-output');
        
        testCases.forEach((testCase, index) => {
            const result = formatResponsePreservingImages(testCase.input);
            
            const testDiv = document.createElement('div');
            testDiv.style.marginBottom = '30px';
            testDiv.style.border = '1px solid #ccc';
            testDiv.style.padding = '15px';
            testDiv.style.borderRadius = '5px';
            
            testDiv.innerHTML = `
                <h4>${testCase.name}</h4>
                <p><strong>입력:</strong></p>
                <pre style="background: #f5f5f5; padding: 10px; border-radius: 3px;">${testCase.input}</pre>
                <p><strong>출력:</strong></p>
                <div style="border: 1px solid #ddd; padding: 10px; background: white; border-radius: 3px;">${result}</div>
                <p><strong>HTML 코드:</strong></p>
                <pre style="background: #f0f0f0; padding: 10px; border-radius: 3px; font-size: 12px; white-space: pre-wrap;">${result.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
            `;
            
            output.appendChild(testDiv);
        });
    </script>
</body>
</html>