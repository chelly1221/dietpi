<?php
/**
 * Version Notice Frontend Admin Class
 * ÌîÑÎ°†Ìä∏ÏóîÎìú Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÎ•º ÏúÑÌïú ÌÅ¥ÎûòÏä§
 */

if (!defined('ABSPATH')) {
    exit;
}

class Version_Notice_Frontend_Admin {
    
    private $table_name;
    
    public function __construct() {
        global $wpdb;
        $this->table_name = $wpdb->prefix . 'version_notices';
        
        // AJAX Ìï∏Îì§Îü¨
        add_action('wp_ajax_vn_frontend_save_notice', array($this, 'ajax_save_notice'));
        add_action('wp_ajax_vn_frontend_delete_notice', array($this, 'ajax_delete_notice'));
        add_action('wp_ajax_vn_frontend_get_notice', array($this, 'ajax_get_notice'));
        add_action('wp_ajax_vn_frontend_save_settings', array($this, 'ajax_save_settings'));
        
        // Ïä§ÌÅ¨Î¶ΩÌä∏ Î∞è Ïä§ÌÉÄÏùº Îì±Î°ù
        add_action('wp_enqueue_scripts', array($this, 'enqueue_frontend_scripts'));
    }
    
    /**
     * ÌîÑÎ°†Ìä∏ÏóîÎìú Í¥ÄÎ¶¨Ïûê ÏáºÌä∏ÏΩîÎìú Î†åÎçîÎßÅ
     */
    public static function render_admin_shortcode($atts) {
        // Í∂åÌïú ÌôïÏù∏
        if (!current_user_can('manage_options')) {
            return self::render_access_denied();
        }
        
        // Í∏∞Ï°¥ ÏÑ§Ï†ï Í∞ÄÏ†∏Ïò§Í∏∞
        $background_image = get_option('version_notice_background_image', '');
        $background_pages = get_option('version_notice_background_pages', array());
        
        // Í≥µÏßÄÏÇ¨Ìï≠ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
        global $wpdb;
        $table_name = $wpdb->prefix . 'version_notices';
        $notices = $wpdb->get_results("SELECT * FROM `{$table_name}` ORDER BY `year_month` DESC, `sort_order` ASC, `id` DESC");
        
        ob_start();
        ?>
        
        <div class="vn-frontend-admin">
            <div class="vn-fa-container">
                <!-- Ìó§Îçî ÏòÅÏó≠ (Î°úÍ≥† + ÌÉ≠) -->
                <header class="vn-fa-header-wrapper">
                    <!-- Î°úÍ≥† ÏÑπÏÖò -->
                    <div class="vn-fa-logo-section">
                        <a href="#" class="vn-fa-logo">
                            <div class="vn-fa-logo-icon">üì¢</div>
                            <span>Î≤ÑÏ†Ñ Í≥µÏßÄÏÇ¨Ìï≠</span>
                        </a>
                    </div>
                    
                    <!-- ÏÉÅÎã® ÌÉ≠ ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
                    <nav class="vn-fa-tabs-nav">
                        <a href="#" class="vn-fa-tab-item active" data-section="notices">
                            <span class="vn-fa-tab-icon">üìù</span>
                            <span class="vn-fa-tab-text">Í≥µÏßÄÏÇ¨Ìï≠</span>
                        </a>
                        <a href="#" class="vn-fa-tab-item" data-section="settings">
                            <span class="vn-fa-tab-icon">‚öôÔ∏è</span>
                            <span class="vn-fa-tab-text">ÏÑ§Ï†ï</span>
                        </a>
                        <a href="#" class="vn-fa-tab-item" data-section="guide">
                            <span class="vn-fa-tab-icon">‚ùì</span>
                            <span class="vn-fa-tab-text">ÏÇ¨Ïö© Î∞©Î≤ï</span>
                        </a>
                    </nav>
                </header>
                
                <!-- Î©îÏù∏ ÏòÅÏó≠ -->
                <main class="vn-fa-main">
                    <!-- ÏïåÎ¶º ÏòÅÏó≠ -->
                    <div class="vn-fa-notice" style="display:none;"></div>
                    
                    <!-- Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨ ÏÑπÏÖò -->
                    <?php self::render_notices_section($notices); ?>
                    
                    <!-- ÏÑ§Ï†ï ÏÑπÏÖò -->
                    <?php self::render_settings_section($background_image, $background_pages); ?>
                    
                    <!-- ÏÇ¨Ïö© Î∞©Î≤ï ÏÑπÏÖò -->
                    <?php self::render_guide_section(); ?>
                </main>
            </div>
        </div>
        
        <?php
        return ob_get_clean();
    }
    
    /**
     * Í≥µÏßÄÏÇ¨Ìï≠ Í¥ÄÎ¶¨ ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private static function render_notices_section($notices) {
        ?>
        <div class="vn-fa-section active" data-section="notices">
            <header class="vn-fa-section-header">
                <div class="vn-fa-header-left">
                    <h1 class="vn-fa-title" style="font-size:28px;">Í≥µÏßÄÏÇ¨Ìï≠</h1>
                </div>
                <div class="vn-fa-header-actions">
                    <button type="button" class="vn-fa-btn-primary" id="add-new-notice">
                        <span class="vn-fa-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Ï∂îÍ∞Ä</span>
                    </button>
                </div>
            </header>
            
            <div class="vn-fa-content">
                <!-- Í≥µÏßÄÏÇ¨Ìï≠ Ìèº (Í∏∞Î≥∏Ï†ÅÏúºÎ°ú Ïà®ÍπÄ) -->
                <div class="vn-fa-notice-form" style="display: none;">
                    <div class="vn-fa-form-card">
                        <h3>
                            <span class="vn-fa-icon">‚úèÔ∏è</span>
                            <span id="form-title">ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Ï∂îÍ∞Ä</span>
                        </h3>
                        
                        <form id="vn-notice-form">
                            <input type="hidden" id="notice-id" value="">
                            
                            <div class="vn-fa-form-grid">
                                <div class="vn-fa-form-group">
                                    <label for="year-month">Ïó∞ÎèÑ-Ïõî</label>
                                    <input type="month" id="year-month" name="year_month" class="vn-fa-input" required>
                                </div>
                                
                                <div class="vn-fa-form-group">
                                    <label for="version-number">Î≤ÑÏ†Ñ Î≤àÌò∏</label>
                                    <input type="text" id="version-number" name="version_number" class="vn-fa-input" placeholder="v3.3.11" required>
                                </div>
                                
                                <div class="vn-fa-form-group">
                                    <label for="notice-date">ÎÇ†Ïßú</label>
                                    <input type="text" id="notice-date" name="notice_date" class="vn-fa-input" placeholder="27Ïùº" required>
                                </div>
                                
                                <div class="vn-fa-form-group">
                                    <label for="sort-order">Ï†ïÎ†¨ ÏàúÏÑú</label>
                                    <input type="number" id="sort-order" name="sort_order" class="vn-fa-input" value="0">
                                </div>
                            </div>
                            
                            <div class="vn-fa-form-group">
                                <label for="title">Ï†úÎ™©</label>
                                <input type="text" id="title" name="title" class="vn-fa-input" required>
                            </div>
                            
                            <div class="vn-fa-form-group">
                                <label for="content">ÎÇ¥Ïö©</label>
                                <textarea id="content" name="content" class="vn-fa-input" rows="5" required></textarea>
                                <p class="vn-fa-help-text">&lt;li&gt; ÌÉúÍ∑∏Î•º ÏÇ¨Ïö©ÌïòÏó¨ Î™©Î°ù Ìï≠Î™©ÏùÑ ÏûëÏÑ±ÌïòÏÑ∏Ïöî.</p>
                            </div>
                            
                            <div class="vn-fa-form-actions">
                                <button type="submit" class="vn-fa-btn-primary">
                                    <span class="vn-fa-icon">üíæ</span>
                                    <span>Ï†ÄÏû•</span>
                                </button>
                                <button type="button" class="vn-fa-btn-secondary" id="cancel-edit">
                                    <span class="vn-fa-icon">‚ùå</span>
                                    <span>Ï∑®ÏÜå</span>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Í≥µÏßÄÏÇ¨Ìï≠ Î™©Î°ù -->
                <div class="vn-fa-notices-list">
                    <?php self::render_notices_list($notices); ?>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Í≥µÏßÄÏÇ¨Ìï≠ Î™©Î°ù Î†åÎçîÎßÅ
     */
    private static function render_notices_list($notices) {
        if (empty($notices)) {
            echo '<div class="vn-fa-empty-state">';
            echo '<span class="vn-fa-icon">üì≠</span>';
            echo '<h3>Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏóÜÏäµÎãàÎã§</h3>';
            echo '<p>ÏÉÅÎã®Ïùò "ÏÉà Í≥µÏßÄÏÇ¨Ìï≠ Ï∂îÍ∞Ä" Î≤ÑÌäºÏùÑ ÌÅ¥Î¶≠ÌïòÏó¨ Ï≤´ Î≤àÏß∏ Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.</p>';
            echo '</div>';
            return;
        }
        
        // Ïó∞ÏõîÎ≥ÑÎ°ú Í∑∏Î£πÌôî
        $grouped = array();
        foreach ($notices as $notice) {
            if (!isset($grouped[$notice->year_month])) {
                $grouped[$notice->year_month] = array();
            }
            $grouped[$notice->year_month][] = $notice;
        }
        
        foreach ($grouped as $year_month => $month_notices) {
            $parts = explode('-', $year_month);
            $year = $parts[0];
            $month = intval($parts[1]);
            
            echo '<div class="vn-fa-notice-group">';
            echo '<div class="vn-fa-group-header">';
            echo '<h3>' . $year . 'ÎÖÑ ' . $month . 'Ïõî</h3>';
            echo '<span class="vn-fa-badge">' . count($month_notices) . 'Í∞ú</span>';
            echo '</div>';
            
            echo '<div class="vn-fa-notice-items">';
            foreach ($month_notices as $notice) {
                echo '<div class="vn-fa-notice-item" data-id="' . $notice->id . '">';
                echo '<div class="vn-fa-notice-header">';
                echo '<div class="vn-fa-notice-meta">';
                echo '<span class="vn-fa-version-tag">' . esc_html($notice->version_number) . '</span>';
                echo '<span class="vn-fa-date">' . esc_html($notice->notice_date) . '</span>';
                echo '<span class="vn-fa-title">' . esc_html($notice->title) . '</span>';
                echo '</div>';
                echo '<div class="vn-fa-notice-actions">';
                echo '<button class="vn-fa-btn-icon edit-notice" data-id="' . $notice->id . '" title="ÏàòÏ†ï">';
                echo '<span class="vn-fa-icon">‚úèÔ∏è</span>';
                echo '</button>';
                echo '<button class="vn-fa-btn-icon delete-notice" data-id="' . $notice->id . '" title="ÏÇ≠Ï†ú">';
                echo '<span class="vn-fa-icon">üóëÔ∏è</span>';
                echo '</button>';
                echo '</div>';
                echo '</div>';
                echo '<div class="vn-fa-notice-content">';
                echo wp_kses_post($notice->content);
                echo '</div>';
                echo '</div>';
            }
            echo '</div>';
            echo '</div>';
        }
    }
    
    /**
     * ÏÑ§Ï†ï ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private static function render_settings_section($background_image, $background_pages) {
        // Î™®Îì† ÌéòÏù¥ÏßÄ Î™©Î°ù Í∞ÄÏ†∏Ïò§Í∏∞
        $pages = get_pages();
        ?>
        <div class="vn-fa-section" data-section="settings">
            <header class="vn-fa-section-header">
                <div class="vn-fa-header-left">
                    <h1 class="vn-fa-title" style="font-size:28px;">ÏÑ§Ï†ï</h1>
                </div>
                <div class="vn-fa-header-actions">
                    <span class="vn-fa-save-status" style="display: none;">
                        <span class="vn-fa-icon">‚úÖ</span>
                        <span>ÏûêÎèô Ï†ÄÏû•Îê®</span>
                    </span>
                </div>
            </header>
            
            <div class="vn-fa-content">
                <div class="vn-fa-settings-grid">
                    <!-- Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï -->
                    <div class="vn-fa-setting-card">
                        <h3>
                            <span class="vn-fa-icon">üé®</span>
                            Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ
                        </h3>
                        <p class="vn-fa-help-text">Î≤ÑÏ†Ñ Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÌëúÏãúÎêòÎäî ÌéòÏù¥ÏßÄÏùò Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ•º ÏÑ§Ï†ïÌï©ÎãàÎã§.</p>
                        
                        <div class="vn-fa-form-group">
                            <label>Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ</label>
                            <div class="vn-fa-image-input-group">
                                <input type="hidden" id="background-image-url" value="<?php echo esc_attr($background_image); ?>">
                                <button type="button" class="vn-fa-btn-secondary" id="upload-background-image">
                                    <span class="vn-fa-icon">üìÅ</span>
                                    Ïù¥ÎØ∏ÏßÄ ÏÑ†ÌÉù
                                </button>
                                <?php if ($background_image): ?>
                                    <button type="button" class="vn-fa-btn-secondary" id="remove-background-image">
                                        <span class="vn-fa-icon">‚ùå</span>
                                        Ïù¥ÎØ∏ÏßÄ Ï†úÍ±∞
                                    </button>
                                <?php endif; ?>
                            </div>
                            
                            <?php if ($background_image): ?>
                                <div class="vn-fa-image-preview" id="background-image-preview">
                                    <img src="<?php echo esc_url($background_image); ?>" alt="Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞">
                                </div>
                            <?php else: ?>
                                <div class="vn-fa-image-preview" id="background-image-preview" style="display: none;">
                                    <img src="" alt="Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÎØ∏Î¶¨Î≥¥Í∏∞">
                                </div>
                            <?php endif; ?>
                        </div>
                    </div>
                    
                    <!-- ÌéòÏù¥ÏßÄ ÏÑ†ÌÉù ÏÑ§Ï†ï -->
                    <div class="vn-fa-setting-card">
                        <h3>
                            <span class="vn-fa-icon">üìÑ</span>
                            Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ Ï†ÅÏö© ÌéòÏù¥ÏßÄ
                        </h3>
                        <p class="vn-fa-help-text">Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎ•º Ï†ÅÏö©Ìï† ÌéòÏù¥ÏßÄÎ•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî.</p>
                        
                        <div class="vn-fa-form-group">
                            <label class="vn-fa-checkbox-label">
                                <input type="checkbox" id="apply-all-pages" <?php echo empty($background_pages) ? 'checked' : ''; ?>>
                                <span>Î™®Îì† Î≤ÑÏ†Ñ Í≥µÏßÄÏÇ¨Ìï≠ ÌéòÏù¥ÏßÄÏóê Ï†ÅÏö©</span>
                            </label>
                        </div>
                        
                        <div id="page-selection" class="vn-fa-page-selection" <?php echo empty($background_pages) ? 'style="display:none;"' : ''; ?>>
                            <p class="vn-fa-help-text">ÌäπÏ†ï ÌéòÏù¥ÏßÄÎßå ÏÑ†ÌÉù:</p>
                            <div class="vn-fa-pages-list">
                                <?php foreach ($pages as $page): ?>
                                    <label class="vn-fa-checkbox-label">
                                        <input type="checkbox" name="background_pages[]" value="<?php echo $page->ID; ?>" 
                                            <?php echo in_array($page->ID, $background_pages) ? 'checked' : ''; ?>>
                                        <span><?php echo esc_html($page->post_title); ?></span>
                                        <span class="vn-fa-page-id">(ID: <?php echo $page->ID; ?>)</span>
                                    </label>
                                <?php endforeach; ?>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÏÇ¨Ïö© Î∞©Î≤ï ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private static function render_guide_section() {
        ?>
        <div class="vn-fa-section" data-section="guide">
            <header class="vn-fa-section-header">
                <div class="vn-fa-header-left">
                    <h1 class="vn-fa-title"  style="font-size:28px;">ÏÇ¨Ïö© Î∞©Î≤ï</h1>
                </div>
            </header>
            
            <div class="vn-fa-content">
                <div class="vn-fa-guide-grid">
                    <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÌëúÏãú -->
                    <div class="vn-fa-guide-card">
                        <h3>
                            <span class="vn-fa-icon">üì¢</span>
                            Í≥µÏßÄÏÇ¨Ìï≠ ÌëúÏãú
                        </h3>
                        <div class="vn-fa-code-block">
                            <code>[version_notice]</code>
                        </div>
                        <p>ÌéòÏù¥ÏßÄÎÇò Ìè¨Ïä§Ìä∏Ïóê ÏúÑ ÏàèÏΩîÎìúÎ•º ÏÇΩÏûÖÌïòÎ©¥ Î≤ÑÏ†Ñ Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÌëúÏãúÎê©ÎãàÎã§.</p>
                        <ul class="vn-fa-feature-list">
                            <li>Ïó∞ÏõîÎ≥Ñ ÏûêÎèô Í∑∏Î£πÌôî</li>
                            <li>ÏïÑÏΩîÎîîÏñ∏ Ïä§ÌÉÄÏùº UI</li>
                            <li>Î∞òÏùëÌòï ÎîîÏûêÏù∏</li>
                            <li>Î™®ÎçòÌïú Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º</li>
                        </ul>
                    </div>
                    
                    <!-- Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ -->
                    <div class="vn-fa-guide-card">
                        <h3>
                            <span class="vn-fa-icon">‚öôÔ∏è</span>
                            Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄ
                        </h3>
                        <div class="vn-fa-code-block">
                            <code>[version_notice_admin]</code>
                        </div>
                        <p>ÌîÑÎ°†Ìä∏ÏóîÎìúÏóêÏÑú Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Í¥ÄÎ¶¨Ìï† Ïàò ÏûàÎäî Í¥ÄÎ¶¨Ïûê ÌéòÏù¥ÏßÄÏûÖÎãàÎã§.</p>
                        <ul class="vn-fa-feature-list">
                            <li>Í¥ÄÎ¶¨Ïûê Í∂åÌïú ÌïÑÏöî</li>
                            <li>Í≥µÏßÄÏÇ¨Ìï≠ Ï∂îÍ∞Ä/ÏàòÏ†ï/ÏÇ≠Ï†ú</li>
                            <li>Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄ ÏÑ§Ï†ï</li>
                            <li>ÌéòÏù¥ÏßÄÎ≥Ñ ÏÑ§Ï†ï Í∞ÄÎä•</li>
                        </ul>
                    </div>
                    
                    <!-- Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ± Í∞ÄÏù¥Îìú -->
                    <div class="vn-fa-guide-card">
                        <h3>
                            <span class="vn-fa-icon">‚úçÔ∏è</span>
                            Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ±
                        </h3>
                        <p>Í≥µÏßÄÏÇ¨Ìï≠ ÏûëÏÑ± Ïãú Îã§Ïùå Ìï≠Î™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî:</p>
                        <ul class="vn-fa-input-guide">
                            <li><strong>Ïó∞ÎèÑ-Ïõî:</strong> Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÜçÌï† Ïó∞Ïõî ÏÑ†ÌÉù</li>
                            <li><strong>Î≤ÑÏ†Ñ Î≤àÌò∏:</strong> Ïòà) v3.3.11</li>
                            <li><strong>ÎÇ†Ïßú:</strong> Ïòà) 27Ïùº</li>
                            <li><strong>Ï†úÎ™©:</strong> ÏóÖÎç∞Ïù¥Ìä∏ Ï†úÎ™©</li>
                            <li><strong>ÎÇ¥Ïö©:</strong> HTML ÏßÄÏõê, &lt;li&gt; ÌÉúÍ∑∏ ÏÇ¨Ïö© Í∂åÏû•</li>
                            <li><strong>Ï†ïÎ†¨ ÏàúÏÑú:</strong> ÎÇÆÏùÄ Ïà´ÏûêÍ∞Ä Î®ºÏ†Ä ÌëúÏãú</li>
                        </ul>
                    </div>
                    
                    <!-- ÌåÅÍ≥º Ï£ºÏùòÏÇ¨Ìï≠ -->
                    <div class="vn-fa-guide-card">
                        <h3>
                            <span class="vn-fa-icon">üí°</span>
                            ÌåÅÍ≥º Ï£ºÏùòÏÇ¨Ìï≠
                        </h3>
                        <div class="vn-fa-info-box">
                            <h4>Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ</h4>
                            <p>Ï§ëÏöîÌïú Í≥µÏßÄÏÇ¨Ìï≠ÏùÄ Ï†ïÍ∏∞Ï†ÅÏúºÎ°ú Î∞±ÏóÖÌïòÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.</p>
                        </div>
                        <div class="vn-fa-info-box">
                            <h4>Ïù¥ÎØ∏ÏßÄ ÏµúÏ†ÅÌôî</h4>
                            <p>Î∞∞Í≤Ω Ïù¥ÎØ∏ÏßÄÎäî 2MB Ïù¥ÌïòÏùò ÏµúÏ†ÅÌôîÎêú Ïù¥ÎØ∏ÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏÑ∏Ïöî.</p>
                        </div>
                        <div class="vn-fa-info-box">
                            <h4>ÌîåÎü¨Í∑∏Ïù∏ Ï†úÍ±∞</h4>
                            <p>ÌîåÎü¨Í∑∏Ïù∏ Ï†úÍ±∞ Ïãú Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÌÖåÏù¥Î∏îÏùÄ Ïú†ÏßÄÎê©ÎãàÎã§. ÏôÑÏ†Ñ Ï†úÍ±∞Î•º ÏõêÌïòÎ©¥ ÏàòÎèôÏúºÎ°ú ÏÇ≠Ï†úÌï¥Ïïº Ìï©ÎãàÎã§.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Ï†ëÍ∑º Í±∞Î∂Ä Î©îÏãúÏßÄ
     */
    private static function render_access_denied() {
        return '
        <div class="vn-fa-access-denied">
            <span class="vn-fa-icon">üö´</span>
            <h3>Ï†ëÍ∑º Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§</h3>
            <p>Ïù¥ ÌéòÏù¥ÏßÄÎäî Í¥ÄÎ¶¨ÏûêÎßå Ï†ëÍ∑ºÌï† Ïàò ÏûàÏäµÎãàÎã§.</p>
        </div>';
    }
    
    /**
     * ÌîÑÎ°†Ìä∏ÏóîÎìú Ïä§ÌÅ¨Î¶ΩÌä∏ Î∞è Ïä§ÌÉÄÏùº Îì±Î°ù
     */
    public function enqueue_frontend_scripts() {
        global $post;
        
        // ÏáºÌä∏ÏΩîÎìúÍ∞Ä ÏûàÎäî ÌéòÏù¥ÏßÄÏù∏ÏßÄ ÌôïÏù∏
        if (is_a($post, 'WP_Post') && has_shortcode($post->post_content, 'version_notice_admin')) {
            // ÎØ∏ÎîîÏñ¥ ÏóÖÎ°úÎçî
            wp_enqueue_media();
            
            // Ïä§ÌÉÄÏùº
            wp_enqueue_style('vn-frontend-admin', VERSION_NOTICE_PLUGIN_URL . 'assets/css/vn-frontend-admin.css', array(), VERSION_NOTICE_VERSION);
            
            // Ïä§ÌÅ¨Î¶ΩÌä∏
            wp_enqueue_script('vn-frontend-admin', VERSION_NOTICE_PLUGIN_URL . 'assets/js/vn-frontend-admin.js', array('jquery'), VERSION_NOTICE_VERSION, true);
            
            // Localization
            wp_localize_script('vn-frontend-admin', 'vn_frontend', array(
                'ajax_url' => admin_url('admin-ajax.php'),
                'nonce' => wp_create_nonce('vn_frontend_nonce'),
                'messages' => array(
                    'save_success' => 'Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.',
                    'save_error' => 'Ï†ÄÏû• Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.',
                    'delete_confirm' => 'Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',
                    'delete_success' => 'ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.',
                    'loading' => 'Î°úÎî© Ï§ë...',
                    'saving' => 'Ï†ÄÏû• Ï§ë...',
                    'saved' => 'ÏûêÎèô Ï†ÄÏû•Îê®'
                )
            ));
        }
    }
    
    /**
     * AJAX: Í≥µÏßÄÏÇ¨Ìï≠ Ï†ÄÏû•
     */
    public function ajax_save_notice() {
        // Nonce Í≤ÄÏ¶ù
        if (!check_ajax_referer('vn_frontend_nonce', 'nonce', false)) {
            wp_send_json_error('Î≥¥Ïïà Í≤ÄÏ¶ù Ïã§Ìå®');
        }
        
        // Í∂åÌïú ÌôïÏù∏
        if (!current_user_can('manage_options')) {
            wp_send_json_error('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.');
        }
        
        global $wpdb;
        
        $id = isset($_POST['id']) ? intval($_POST['id']) : 0;
        $data = array(
            'version_number' => sanitize_text_field($_POST['version_number']),
            'notice_date' => sanitize_text_field($_POST['notice_date']),
            'title' => sanitize_text_field($_POST['title']),
            'content' => wp_kses_post($_POST['content']),
            'year_month' => sanitize_text_field($_POST['year_month']),
            'sort_order' => intval($_POST['sort_order'])
        );
        
        if ($id > 0) {
            $result = $wpdb->update($this->table_name, $data, array('id' => $id));
        } else {
            $data['created_at'] = current_time('mysql');
            $result = $wpdb->insert($this->table_name, $data);
        }
        
        if ($result !== false) {
            wp_send_json_success(array(
                'message' => 'Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.',
                'id' => $id > 0 ? $id : $wpdb->insert_id
            ));
        } else {
            wp_send_json_error('Ï†ÄÏû• Ïã§Ìå®: ' . $wpdb->last_error);
        }
    }
    
    /**
     * AJAX: Í≥µÏßÄÏÇ¨Ìï≠ ÏÇ≠Ï†ú
     */
    public function ajax_delete_notice() {
        // Nonce Í≤ÄÏ¶ù
        if (!check_ajax_referer('vn_frontend_nonce', 'nonce', false)) {
            wp_send_json_error('Î≥¥Ïïà Í≤ÄÏ¶ù Ïã§Ìå®');
        }
        
        // Í∂åÌïú ÌôïÏù∏
        if (!current_user_can('manage_options')) {
            wp_send_json_error('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.');
        }
        
        global $wpdb;
        
        $id = intval($_POST['id']);
        $result = $wpdb->delete($this->table_name, array('id' => $id));
        
        if ($result !== false) {
            wp_send_json_success('Í≥µÏßÄÏÇ¨Ìï≠Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
        } else {
            wp_send_json_error('ÏÇ≠Ï†ú Ïã§Ìå®');
        }
    }
    
    /**
     * AJAX: Í≥µÏßÄÏÇ¨Ìï≠ Í∞ÄÏ†∏Ïò§Í∏∞
     */
    public function ajax_get_notice() {
        // Nonce Í≤ÄÏ¶ù
        if (!check_ajax_referer('vn_frontend_nonce', 'nonce', false)) {
            wp_send_json_error('Î≥¥Ïïà Í≤ÄÏ¶ù Ïã§Ìå®');
        }
        
        global $wpdb;
        
        $id = intval($_POST['id']);
        $notice = $wpdb->get_row($wpdb->prepare(
            "SELECT * FROM $this->table_name WHERE id = %d",
            $id
        ));
        
        if ($notice) {
            wp_send_json_success($notice);
        } else {
            wp_send_json_error('Í≥µÏßÄÏÇ¨Ìï≠ÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
        }
    }
    
    /**
     * AJAX: ÏÑ§Ï†ï Ï†ÄÏû•
     */
    public function ajax_save_settings() {
        // Nonce Í≤ÄÏ¶ù
        if (!check_ajax_referer('vn_frontend_nonce', 'nonce', false)) {
            wp_send_json_error('Î≥¥Ïïà Í≤ÄÏ¶ù Ïã§Ìå®');
        }
        
        // Í∂åÌïú ÌôïÏù∏
        if (!current_user_can('manage_options')) {
            wp_send_json_error('Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.');
        }
        
        $background_image = sanitize_text_field($_POST['background_image']);
        $background_pages = isset($_POST['background_pages']) ? array_map('intval', $_POST['background_pages']) : array();
        
        update_option('version_notice_background_image', $background_image);
        update_option('version_notice_background_pages', $background_pages);
        
        wp_send_json_success('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
    }
}