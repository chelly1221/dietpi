<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KACHI AI Search - Content Capture Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { border: 1px solid #ccc; padding: 15px; margin: 10px 0; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { padding: 10px 15px; margin: 5px; }
        pre { background: #f4f4f4; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>KACHI AI Search Content Capture Test (v2.5.0)</h1>
    
    <div class="test-section">
        <h2>Debug System Test</h2>
        <button onclick="testDebugSystem()">Test Debug Metrics</button>
        <button onclick="showHealthReport()">Show Health Report</button>
        <div id="debug-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Content Capture Simulation</h2>
        <button onclick="simulateContentCapture()">Simulate Content Capture</button>
        <button onclick="simulateLLMResponse()">Simulate LLM Response</button>
        <div id="capture-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Processing Pipeline Test</h2>
        <button onclick="testProcessingPipeline()">Test Processing Pipeline</button>
        <div id="pipeline-results"></div>
    </div>

    <script>
        // Mock KachiCore debug system for testing
        const MockKachiCore = {
            debug: {
                metrics: {
                    captureAttempts: 0,
                    captureSuccesses: 0,
                    captureFailures: 0,
                    streamBufferSuccesses: 0,
                    domExtractionSuccesses: 0,
                    snapshotRecoveries: 0,
                    processingStepFailures: 0,
                    llmResponsesLost: 0,
                    llmResponsesSaved: 0
                },
                recordCaptureAttempt: function() { this.metrics.captureAttempts++; },
                recordCaptureSuccess: function() { this.metrics.captureSuccesses++; },
                recordCaptureFailure: function() { this.metrics.captureFailures++; },
                recordLLMResponseSaved: function() { this.metrics.llmResponsesSaved++; },
                recordLLMResponseLost: function() { this.metrics.llmResponsesLost++; },
                recordProcessingStepFailure: function() { this.metrics.processingStepFailures++; },
                recordMetric: function(metricName) { 
                    if (this.metrics[metricName] !== undefined) this.metrics[metricName]++;
                },
                getHealthReport: function() {
                    const captureTotal = this.metrics.captureAttempts;
                    const captureRate = captureTotal > 0 ? Math.round((this.metrics.captureSuccesses / captureTotal) * 100) : 0;
                    const llmTotal = this.metrics.llmResponsesSaved + this.metrics.llmResponsesLost;
                    const llmSaveRate = llmTotal > 0 ? Math.round((this.metrics.llmResponsesSaved / llmTotal) * 100) : 0;
                    
                    return {
                        overallHealth: captureRate >= 90 ? 'EXCELLENT' : captureRate >= 75 ? 'GOOD' : 'FAIR',
                        contentCaptureRate: captureRate + '%',
                        llmResponseSaveRate: llmSaveRate + '%',
                        captureAttempts: this.metrics.captureAttempts,
                        captureSuccesses: this.metrics.captureSuccesses,
                        captureFailures: this.metrics.captureFailures,
                        llmResponsesSaved: this.metrics.llmResponsesSaved,
                        llmResponsesLost: this.metrics.llmResponsesLost,
                        processingStepFailures: this.metrics.processingStepFailures
                    };
                }
            }
        };

        function testDebugSystem() {
            const results = document.getElementById('debug-results');
            results.innerHTML = '<div class="info">Testing debug system...</div>';
            
            // Simulate various events
            MockKachiCore.debug.recordCaptureAttempt();
            MockKachiCore.debug.recordCaptureSuccess();
            MockKachiCore.debug.recordLLMResponseSaved();
            
            MockKachiCore.debug.recordCaptureAttempt();
            MockKachiCore.debug.recordCaptureFailure();
            MockKachiCore.debug.recordLLMResponseLost();
            
            MockKachiCore.debug.recordMetric('streamBufferSuccesses');
            MockKachiCore.debug.recordMetric('processingStepFailures');
            
            const report = MockKachiCore.debug.getHealthReport();
            
            results.innerHTML = `
                <div class="success">✅ Debug system test completed</div>
                <pre>Metrics: ${JSON.stringify(MockKachiCore.debug.metrics, null, 2)}</pre>
                <pre>Health Report: ${JSON.stringify(report, null, 2)}</pre>
            `;
        }

        function showHealthReport() {
            const results = document.getElementById('debug-results');
            const report = MockKachiCore.debug.getHealthReport();
            
            results.innerHTML = `
                <h3>Current Health Report</h3>
                <div class="${report.overallHealth === 'EXCELLENT' ? 'success' : report.overallHealth === 'GOOD' ? 'info' : 'error'}">
                    Overall Health: ${report.overallHealth}
                </div>
                <p>Content Capture Rate: ${report.contentCaptureRate}</p>
                <p>LLM Response Save Rate: ${report.llmResponseSaveRate}</p>
                <p>Total Capture Attempts: ${report.captureAttempts}</p>
                <p>Processing Failures: ${report.processingStepFailures}</p>
            `;
        }

        function simulateContentCapture() {
            const results = document.getElementById('capture-results');
            results.innerHTML = '<div class="info">Simulating content capture strategies...</div>';
            
            // Simulate successful capture
            MockKachiCore.debug.recordCaptureAttempt();
            MockKachiCore.debug.recordCaptureSuccess();
            MockKachiCore.debug.recordMetric('streamBufferSuccesses');
            
            // Simulate failure with fallback
            MockKachiCore.debug.recordCaptureAttempt();
            MockKachiCore.debug.recordCaptureSuccess();
            MockKachiCore.debug.recordMetric('domExtractionSuccesses');
            
            // Simulate complete failure
            MockKachiCore.debug.recordCaptureAttempt();
            MockKachiCore.debug.recordCaptureFailure();
            
            results.innerHTML = `
                <div class="success">✅ Content capture simulation completed</div>
                <p>Capture Success Rate: ${Math.round((MockKachiCore.debug.metrics.captureSuccesses / MockKachiCore.debug.metrics.captureAttempts) * 100)}%</p>
                <p>Stream Buffer Successes: ${MockKachiCore.debug.metrics.streamBufferSuccesses}</p>
                <p>DOM Extraction Successes: ${MockKachiCore.debug.metrics.domExtractionSuccesses}</p>
            `;
        }

        function simulateLLMResponse() {
            const results = document.getElementById('capture-results');
            results.innerHTML = '<div class="info">Simulating LLM response saving...</div>';
            
            // Simulate successful saves
            for(let i = 0; i < 5; i++) {
                MockKachiCore.debug.recordLLMResponseSaved();
            }
            
            // Simulate lost responses
            for(let i = 0; i < 2; i++) {
                MockKachiCore.debug.recordLLMResponseLost();
            }
            
            const total = MockKachiCore.debug.metrics.llmResponsesSaved + MockKachiCore.debug.metrics.llmResponsesLost;
            const saveRate = Math.round((MockKachiCore.debug.metrics.llmResponsesSaved / total) * 100);
            
            results.innerHTML = `
                <div class="success">✅ LLM response simulation completed</div>
                <p>LLM Response Save Rate: ${saveRate}%</p>
                <p>Responses Saved: ${MockKachiCore.debug.metrics.llmResponsesSaved}</p>
                <p>Responses Lost: ${MockKachiCore.debug.metrics.llmResponsesLost}</p>
            `;
        }

        function testProcessingPipeline() {
            const results = document.getElementById('pipeline-results');
            results.innerHTML = '<div class="info">Testing processing pipeline...</div>';
            
            // Simulate processing step failures
            MockKachiCore.debug.recordProcessingStepFailure();
            MockKachiCore.debug.recordProcessingStepFailure();
            
            results.innerHTML = `
                <div class="success">✅ Processing pipeline test completed</div>
                <p>Processing Step Failures: ${MockKachiCore.debug.metrics.processingStepFailures}</p>
                <div class="info">
                    Processing pipeline includes:
                    <ul>
                        <li>Image tag fixing</li>
                        <li>Image URL processing for storage</li>
                        <li>MathJax content cleaning</li>
                        <li>Content validation at each step</li>
                    </ul>
                </div>
            `;
        }

        // Show initial state
        window.onload = function() {
            showHealthReport();
        };
    </script>
</body>
</html>