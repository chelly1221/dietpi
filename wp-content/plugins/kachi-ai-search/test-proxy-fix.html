<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proxy URL Fix Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin-bottom: 30px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; }
        .input { background: #f5f5f5; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .result { background: #e8f5e8; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        pre { font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>Proxy URL Fix Test</h1>
    <div id="test-results"></div>

    <script>
        // Mock the WordPress AJAX URL for testing
        window.kachi_ajax = {
            ajax_url: 'http://kac.chelly.kr/wp-admin/admin-ajax.php'
        };

        // Mock the convertToProxyImageUrl function from kachi-api.js
        function mockConvertToProxyImageUrl(imageUrl) {
            console.log('üñºÔ∏è [TEST] Converting URL:', imageUrl);
            
            // Already proxy URL check
            if (imageUrl.includes('action=kachi_proxy_image')) {
                console.log("üñºÔ∏è [TEST] Already proxy URL, skipping conversion:", imageUrl);
                return imageUrl;
            }
            
            // Empty or data URL check
            if (!imageUrl || imageUrl.startsWith('data:')) {
                return imageUrl;
            }
            
            // API server pattern check
            const apiPattern = /:8001\/images\/([^?\s)]+)/;
            const match = imageUrl.match(apiPattern);
            
            if (match && match[1]) {
                // Convert to proxy URL using WordPress AJAX
                const imagePath = match[1];
                const proxyUrl = window.kachi_ajax.ajax_url + 
                    '?action=kachi_proxy_image&path=' + encodeURIComponent(imagePath);
                console.log("üñºÔ∏è [TEST] Converting to proxy URL:", imageUrl, "->", proxyUrl);
                return proxyUrl;
            }
            
            // No match, return cleaned URL
            console.warn("‚ö†Ô∏è [TEST] No API pattern match for:", imageUrl);
            return imageUrl;
        }

        // Test cases to validate the proxy URL fix
        const testCases = [
            {
                name: "Internal server image URL",
                input: "http://192.168.10.101:8001/images/7e6063e2.jpg",
                expected: "should convert to WordPress AJAX proxy format"
            },
            {
                name: "Internal server image URL with query params", 
                input: "http://192.168.10.101:8001/images/test.png?v=123",
                expected: "should convert to WordPress AJAX proxy format"
            },
            {
                name: "Already proxied URL",
                input: "http://kac.chelly.kr/wp-admin/admin-ajax.php?action=kachi_proxy_image&path=test.jpg",
                expected: "should return as-is"
            },
            {
                name: "External URL", 
                input: "https://example.com/image.jpg",
                expected: "should return as-is (no proxy needed for external)"
            },
            {
                name: "Data URL",
                input: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",
                expected: "should return as-is"
            }
        ];

        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            
            testCases.forEach((testCase, index) => {
                console.log(`\n=== Test ${index + 1}: ${testCase.name} ===`);
                
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                testDiv.innerHTML = `<h3>Test ${index + 1}: ${testCase.name}</h3>`;
                
                const inputDiv = document.createElement('div');
                inputDiv.className = 'input';
                inputDiv.innerHTML = `<strong>Input:</strong><br><pre>${testCase.input}</pre>`;
                testDiv.appendChild(inputDiv);
                
                // Run the conversion
                const result = mockConvertToProxyImageUrl(testCase.input);
                
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result';
                resultDiv.innerHTML = `<strong>Result:</strong><br><pre>${result}</pre>`;
                
                // Validation
                let isValid = false;
                let validationMessage = '';
                
                if (testCase.name.includes('Internal server')) {
                    isValid = result.includes('wp-admin/admin-ajax.php') && 
                             result.includes('action=kachi_proxy_image') && 
                             !result.includes('192.168.10.101');
                    validationMessage = isValid ? 
                        '‚úÖ Correctly converted to WordPress AJAX format' : 
                        '‚ùå Failed to convert to proper WordPress AJAX format';
                } else if (testCase.name.includes('Already proxied')) {
                    isValid = result === testCase.input;
                    validationMessage = isValid ? 
                        '‚úÖ Correctly returned as-is' : 
                        '‚ùå Should not have been modified';
                } else {
                    isValid = result === testCase.input;
                    validationMessage = isValid ? 
                        '‚úÖ Correctly returned unchanged' : 
                        '‚ùå Should not have been modified';
                }
                
                const validationDiv = document.createElement('div');
                validationDiv.className = isValid ? 'success' : 'error';
                validationDiv.innerHTML = validationMessage;
                resultDiv.appendChild(validationDiv);
                
                const expectedDiv = document.createElement('div');
                expectedDiv.innerHTML = `<strong>Expected:</strong> ${testCase.expected}`;
                resultDiv.appendChild(expectedDiv);
                
                testDiv.appendChild(resultDiv);
                resultsDiv.appendChild(testDiv);
                
                console.log('Input:', testCase.input);
                console.log('Result:', result);
                console.log('Valid:', isValid, '-', validationMessage);
            });
        }

        // Run tests
        runTests();
        
        console.log('\n=== Proxy URL Fix Test Complete ===');
    </script>
</body>
</html>