<?php
/**
 * Dashboard Rendering Class
 */

// ÏßÅÏ†ë Ï†ëÍ∑º Î∞©ÏßÄ
if (!defined('ABSPATH')) {
    exit;
}

class SD_Dashboard {
    
    /**
     * ÎåÄÏãúÎ≥¥Îìú ÏàèÏΩîÎìú Î†åÎçîÎßÅ
     */
    public function render_dashboard_shortcode($atts) {
        $atts = shortcode_atts(array(
            'theme' => 'dark'
        ), $atts);
        
        ob_start();
        ?>
        <div class="sd-dashboard" data-theme="<?php echo esc_attr($atts['theme']); ?>">
            <div class="sd-container">
                <!-- Header -->
                <?php $this->render_header(); ?>
                
                <!-- Main Content -->
                <main class="sd-main">
                    <!-- Loading State -->
                    <?php $this->render_loading_state(); ?>
                    
                    <!-- Error State -->
                    <?php $this->render_error_state(); ?>
                    
                    <!-- Overview Section -->
                    <?php $this->render_overview_section(); ?>
                    
                    <!-- Storage Section -->
                    <?php $this->render_storage_section(); ?>
                    
                    <!-- Servers Section -->
                    <?php $this->render_servers_section(); ?>
                    
                    <!-- Settings Section -->
                    <?php $this->render_settings_section(); ?>
                </main>
            </div>
            
            <!-- Hidden data attributes -->
            <div id="sd-config" 
                data-sosok="Í¥ÄÎ¶¨Ïûê"
                data-buseo="Í¥ÄÎ¶¨Ïûê"
                data-site="Í¥ÄÎ¶¨Ïûê">
            </div>
            
            <!-- Filter Modal -->
            <?php $this->render_filter_modal(); ?>
        </div>
        
        <!-- Inline initialization script -->
        <?php $this->render_inline_script(); ?>
        <?php
        
        return ob_get_clean();
    }
    
    /**
     * Ìó§Îçî Î†åÎçîÎßÅ
     */
    private function render_header() {
        ?>
        <header class="sd-header-wrapper">
            <div class="sd-logo-section">
                <div class="sd-logo">
                    <div class="sd-logo-icon">üìä</div>
                    <span>ÌÜµÍ≥Ñ ÎåÄÏãúÎ≥¥Îìú</span>
                </div>
            </div>
            
            <!-- Tab Navigation -->
            <nav class="sd-tabs-nav">
                <a href="#" class="sd-tab-item active" data-section="overview">
                    <span class="sd-tab-icon">üìà</span>
                    <span class="sd-tab-text">Í∞úÏöî</span>
                </a>
                <a href="#" class="sd-tab-item" data-section="storage">
                    <span class="sd-tab-icon">üíæ</span>
                    <span class="sd-tab-text">Ï†ÄÏû•ÏÜå</span>
                </a>
                <a href="#" class="sd-tab-item" data-section="servers">
                    <span class="sd-tab-icon">üñ•Ô∏è</span>
                    <span class="sd-tab-text">ÏÑúÎ≤Ñ</span>
                </a>
                <a href="#" class="sd-tab-item" data-section="settings">
                    <span class="sd-tab-icon">‚öôÔ∏è</span>
                    <span class="sd-tab-text">ÏÑ§Ï†ï</span>
                </a>
            </nav>
        </header>
        <?php
    }
    
    /**
     * Î°úÎî© ÏÉÅÌÉú Î†åÎçîÎßÅ
     */
    private function render_loading_state() {
        ?>
        <div class="sd-loading-state">
            <div class="sd-spinner"></div>
            <p>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§Îäî Ï§ë...</p>
        </div>
        <?php
    }
    
    /**
     * ÏóêÎü¨ ÏÉÅÌÉú Î†åÎçîÎßÅ
     */
    private function render_error_state() {
        ?>
        <div class="sd-error-state" style="display: none;">
            <div class="sd-error-icon">‚ö†Ô∏è</div>
            <h3>Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§</h3>
            <p class="sd-error-message"></p>
            <button class="sd-btn-primary sd-retry-btn">
                <svg class="sd-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 2v6h-6"></path>
                    <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                    <path d="M3 22v-6h6"></path>
                    <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                </svg>
                <span>Îã§Ïãú ÏãúÎèÑ</span>
            </button>
        </div>
        <?php
    }
    
    /**
     * Í∞úÏöî ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private function render_overview_section() {
        ?>
        <div class="sd-section active" data-section="overview">
            <div class="sd-section-header">
                <h2 class="sd-section-title">Ï†ÑÏ≤¥ Í∞úÏöî</h2>
                <div class="sd-header-controls">
                    <div class="sd-header-buttons">
                        <button class="sd-filter-btn" id="overview-filter-btn">
                            <svg class="sd-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            <span>ÌïÑÌÑ∞</span>
                        </button>
                        <button class="sd-btn-secondary sd-refresh-btn">
                            <svg class="sd-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                            </svg>
                            <span>ÏÉàÎ°úÍ≥†Ïπ®</span>
                        </button>
                    </div>
                    <div class="sd-header-status">
                        <div class="sd-filter-status" id="overview-filter-status">
                            <span class="sd-status-label">ÌïÑÌÑ∞:</span>
                            <span id="overview-filter-text">Í¥ÄÎ¶¨Ïûê > Í¥ÄÎ¶¨Ïûê > Í¥ÄÎ¶¨Ïûê</span>
                        </div>
                        <div class="sd-last-updated"></div>
                    </div>
                </div>
            </div>
            
            <div class="sd-content">
                <!-- Stats Cards -->
                <?php $this->render_stats_cards(); ?>
                
                <!-- Upload Timeline Section -->
                <?php $this->render_upload_timeline(); ?>
                
                <!-- Documents Distribution Section -->
                <?php $this->render_documents_distribution(); ?>
                
                <!-- Charts Row -->
                <?php $this->render_charts_row(); ?>
                
                <!-- Recent Uploads -->
                <?php $this->render_recent_uploads(); ?>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÌÜµÍ≥Ñ Ïπ¥Îìú Î†åÎçîÎßÅ
     */
    private function render_stats_cards() {
        ?>
        <div class="sd-stats-grid">
            <div class="sd-stat-card">
                <div class="sd-stat-icon">üìÑ</div>
                <div class="sd-stat-content">
                    <h3>Ï†ÑÏ≤¥ Î¨∏ÏÑú</h3>
                    <p class="sd-stat-value" id="total-documents">-</p>
                    <span class="sd-stat-label">Í∞ú</span>
                </div>
            </div>
            
            <div class="sd-stat-card">
                <div class="sd-stat-icon">üìë</div>
                <div class="sd-stat-content">
                    <h3>Ï†ÑÏ≤¥ ÏÑπÏÖò</h3>
                    <p class="sd-stat-value" id="total-sections">-</p>
                    <span class="sd-stat-label">Í∞ú</span>
                </div>
            </div>
            
            <div class="sd-stat-card">
                <div class="sd-stat-icon">üìä</div>
                <div class="sd-stat-content">
                    <h3>ÌèâÍ∑† ÏÑπÏÖò</h3>
                    <p class="sd-stat-value" id="avg-sections">-</p>
                    <span class="sd-stat-label">Í∞ú/Î¨∏ÏÑú</span>
                </div>
            </div>
            
            <div class="sd-stat-card">
                <div class="sd-stat-icon">üè¢</div>
                <div class="sd-stat-content">
                    <h3>ÏÜåÏÜç</h3>
                    <p class="sd-stat-value" id="total-sosok">-</p>
                    <span class="sd-stat-label">Í∞ú</span>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÏóÖÎ°úÎìú ÌÉÄÏûÑÎùºÏù∏ Î†åÎçîÎßÅ
     */
    private function render_upload_timeline() {
        ?>
        <div class="sd-upload-timeline-section">
            <div class="sd-timeline-header">
                <h3>ÏóÖÎ°úÎìú ÌòÑÌô©</h3>
                <div class="sd-date-filter">
                    <label>Í∏∞Í∞Ñ:</label>
                    <select id="upload-days-filter">
                        <option value="7">ÏµúÍ∑º 7Ïùº</option>
                        <option value="30" selected>ÏµúÍ∑º 30Ïùº</option>
                        <option value="60">ÏµúÍ∑º 60Ïùº</option>
                        <option value="90">ÏµúÍ∑º 90Ïùº</option>
                    </select>
                </div>
            </div>
            
            <div class="sd-uploads-chart-card">
                <canvas id="chart-uploads-timeline"></canvas>
            </div>
            
            <div class="sd-upload-stats">
                <div class="sd-stat-mini">
                    <span class="sd-stat-mini-label">Ï¥ù ÏóÖÎ°úÎìú:</span>
                    <span class="sd-stat-mini-value" id="total-uploads">-</span>
                </div>
                <div class="sd-stat-mini">
                    <span class="sd-stat-mini-label">Ïùº ÌèâÍ∑†:</span>
                    <span class="sd-stat-mini-value" id="avg-uploads">-</span>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Î¨∏ÏÑú Î∂ÑÌè¨ Î†åÎçîÎßÅ
     */
    private function render_documents_distribution() {
        ?>
        <div class="sd-documents-section">
            <h3>Î¨∏ÏÑú Î∂ÑÌè¨</h3>
            <div class="sd-documents-grid">
                <!-- By Sosok Chart -->
                <div class="sd-chart-card">
                    <h4>ÏÜåÏÜçÎ≥Ñ Î¨∏ÏÑú Î∂ÑÌè¨ (ÏÉÅÏúÑ 10Í∞ú)</h4>
                    <div class="sd-chart-container">
                        <canvas id="chart-by-sosok"></canvas>
                    </div>
                </div>
                
                <!-- By Buseo Chart -->
                <div class="sd-chart-card">
                    <h4>Î∂ÄÏÑúÎ≥Ñ Î¨∏ÏÑú Î∂ÑÌè¨ (ÏÉÅÏúÑ 10Í∞ú)</h4>
                    <div class="sd-chart-container">
                        <canvas id="chart-by-buseo"></canvas>
                    </div>
                </div>
                
                <!-- By Site Chart -->
                <div class="sd-chart-card">
                    <h4>ÌòÑÏû•Î≥Ñ Î¨∏ÏÑú Î∂ÑÌè¨ (ÏÉÅÏúÑ 10Í∞ú)</h4>
                    <div class="sd-chart-container">
                        <canvas id="chart-by-site"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Ï∞®Ìä∏ Ìñâ Î†åÎçîÎßÅ
     */
    private function render_charts_row() {
        ?>
        <div class="sd-charts-row">
            <!-- Document Types Chart -->
            <div class="sd-chart-card">
                <h3>Î¨∏ÏÑú Ïú†ÌòïÎ≥Ñ Î∂ÑÌè¨</h3>
                <div class="sd-chart-container">
                    <canvas id="chart-document-types"></canvas>
                </div>
            </div>
            
            <!-- Popular Tags -->
            <div class="sd-chart-card">
                <h3>Ïù∏Í∏∞ ÌÉúÍ∑∏</h3>
                <div class="sd-tags-list" id="popular-tags">
                    <!-- Tags will be populated here -->
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÏµúÍ∑º ÏóÖÎ°úÎìú Î†åÎçîÎßÅ
     */
    private function render_recent_uploads() {
        ?>
        <div class="sd-recent-uploads">
            <h3>ÏµúÍ∑º ÏóÖÎ°úÎìú</h3>
            <div class="sd-uploads-list" id="recent-uploads">
                <!-- Recent uploads will be populated here -->
            </div>
        </div>
        <?php
    }
    
    /**
     * Ï†ÄÏû•ÏÜå ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private function render_storage_section() {
        ?>
        <div class="sd-section" data-section="storage">
            <div class="sd-section-header">
                <h2 class="sd-section-title">Ï†ÄÏû•ÏÜå ÌÜµÍ≥Ñ</h2>
                <div class="sd-header-controls">
                    <div class="sd-header-buttons">
                        <button class="sd-filter-btn" id="storage-filter-btn">
                            <svg class="sd-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                            </svg>
                            <span>ÌïÑÌÑ∞</span>
                        </button>
                    </div>
                    <div class="sd-header-status">
                        <div class="sd-filter-status" id="storage-filter-status">
                            <span class="sd-status-label">ÌïÑÌÑ∞:</span>
                            <span id="storage-filter-text">Í¥ÄÎ¶¨Ïûê > Í¥ÄÎ¶¨Ïûê > Í¥ÄÎ¶¨Ïûê</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sd-content">
                <div class="sd-storage-stats" id="storage-stats">
                    <!-- Storage stats will be populated here -->
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÏÑúÎ≤Ñ ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private function render_servers_section() {
        ?>
        <div class="sd-section" data-section="servers">
            <div class="sd-section-header">
                <h2 class="sd-section-title">ÏÑúÎ≤Ñ Î™®ÎãàÌÑ∞ÎßÅ</h2>
                <div class="sd-header-controls">
                    <div class="sd-header-buttons">
                        <button class="sd-btn-secondary sd-refresh-servers-btn">
                            <svg class="sd-icon-svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"></path>
                                <path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path>
                                <path d="M3 22v-6h6"></path>
                                <path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path>
                            </svg>
                            <span>ÏÉàÎ°úÍ≥†Ïπ®</span>
                        </button>
                    </div>
                    <div class="sd-header-status">
                        <div class="sd-last-updated" id="servers-last-updated"></div>
                    </div>
                </div>
            </div>
            
            <div class="sd-content">
                <div class="sd-servers-grid" id="servers-stats">
                    <!-- Server stats will be populated here -->
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÏÑ§Ï†ï ÏÑπÏÖò Î†åÎçîÎßÅ
     */
    private function render_settings_section() {
        ?>
        <div class="sd-section" data-section="settings">
            <div class="sd-section-header">
                <h2 class="sd-section-title">ÏÑ§Ï†ï</h2>
                <div class="sd-header-controls">
                    <button type="button" class="sd-btn-primary" id="save-settings">
                        <span class="sd-icon">üíæ</span>
                        <span>ÏÑ§Ï†ï Ï†ÄÏû•</span>
                    </button>
                    <div class="sd-save-status" style="display: none;">
                        <span class="sd-icon">‚úÖ</span>
                        <span>Ï†ÄÏû•Îê®</span>
                    </div>
                </div>
            </div>
            
            <div class="sd-content">
                <div class="sd-settings-grid">
                    <!-- AI ÏÑúÎ≤Ñ API ÏÑ§Ï†ï -->
                    <div class="sd-setting-card">
                        <h3>
                            <span class="sd-icon">ü§ñ</span>
                            AI ÏÑúÎ≤Ñ API ÏÑ§Ï†ï
                        </h3>
                        <p class="sd-help-text">Î©îÏù∏ Python Î∞±ÏóîÎìú API ÏÑúÎ≤Ñ Ï†ïÎ≥¥Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§.</p>
                        
                        <div class="sd-form-group">
                            <label for="api-base-url">AI ÏÑúÎ≤Ñ API URL</label>
                            <input type="url" id="api-base-url" class="sd-input" 
                                value="<?php echo esc_attr(get_option('sd_api_base_url')); ?>" 
                                placeholder="http://192.168.1.101:8000">
                            <p class="sd-help-text">Python FastAPI ÏÑúÎ≤ÑÏùò Í∏∞Î≥∏ URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</p>
                        </div>
                        
                        <div class="sd-form-actions">
                            <button type="button" class="sd-btn-primary" id="test-ai-connection">
                                <span class="sd-icon">üîç</span>
                                <span>Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</span>
                            </button>
                        </div>
                        
                        <div class="sd-test-result" id="test-ai-result" style="display: none;">
                            <!-- ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                    
                    <!-- LLM GPU API ÏÑ§Ï†ï -->
                    <div class="sd-setting-card">
                        <h3>
                            <span class="sd-icon">üéÆ</span>
                            LLM GPU API ÏÑ§Ï†ï
                        </h3>
                        <p class="sd-help-text">LLM GPU Î™®ÎãàÌÑ∞ÎßÅ API Ï†ïÎ≥¥Î•º ÏÑ§Ï†ïÌï©ÎãàÎã§.</p>
                        
                        <div class="sd-form-group">
                            <label for="llm-gpu-api-url">LLM GPU API URL</label>
                            <input type="url" id="llm-gpu-api-url" class="sd-input" 
                                value="<?php echo esc_attr(get_option('sd_llm_gpu_api_url')); ?>" 
                                placeholder="http://192.168.1.101:8000/gpu">
                            <p class="sd-help-text">LLM GPU ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï† Ïàò ÏûàÎäî API URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</p>
                        </div>
                        
                        <div class="sd-form-actions">
                            <button type="button" class="sd-btn-primary" id="test-gpu-connection">
                                <span class="sd-icon">üîç</span>
                                <span>Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</span>
                            </button>
                        </div>
                        
                        <div class="sd-test-result" id="test-gpu-result" style="display: none;">
                            <!-- ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                    
                    <!-- WEB ÏÑúÎ≤Ñ API ÏÑ§Ï†ï -->
                    <div class="sd-setting-card">
                        <h3>
                            <span class="sd-icon">üåê</span>
                            WEB ÏÑúÎ≤Ñ API ÏÑ§Ï†ï
                        </h3>
                        <p class="sd-help-text">Ïõπ ÏÑúÎ≤Ñ ÏÉÅÌÉú Ï≤¥ÌÅ¨ URLÏùÑ ÏÑ§Ï†ïÌï©ÎãàÎã§.</p>
                        
                        <div class="sd-form-group">
                            <label for="web-server-api-url">WEB ÏÑúÎ≤Ñ URL</label>
                            <input type="url" id="web-server-api-url" class="sd-input" 
                                value="<?php echo esc_attr(get_option('sd_web_server_api_url')); ?>" 
                                placeholder="https://example.com">
                            <p class="sd-help-text">Ïõπ ÏÑúÎ≤ÑÏùò ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï† URLÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî.</p>
                        </div>
                        
                        <div class="sd-form-actions">
                            <button type="button" class="sd-btn-primary" id="test-web-connection">
                                <span class="sd-icon">üîç</span>
                                <span>Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</span>
                            </button>
                        </div>
                        
                        <div class="sd-test-result" id="test-web-result" style="display: none;">
                            <!-- ÌÖåÏä§Ìä∏ Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                        </div>
                    </div>
                    
                    <!-- Í≥µÌÜµ ÏÑ§Ï†ï -->
                    <div class="sd-setting-card">
                        <h3>
                            <span class="sd-icon">‚öôÔ∏è</span>
                            Í≥µÌÜµ ÏÑ§Ï†ï
                        </h3>
                        <p class="sd-help-text">Î™®Îì† APIÏóê Ï†ÅÏö©ÎêòÎäî Í≥µÌÜµ ÏÑ§Ï†ïÏûÖÎãàÎã§.</p>
                        
                        <div class="sd-form-group">
                            <label for="api-timeout">ÏöîÏ≤≠ ÌÉÄÏûÑÏïÑÏõÉ (Ï¥à)</label>
                            <input type="number" id="api-timeout" class="sd-input" 
                                value="<?php echo esc_attr(get_option('sd_api_timeout')); ?>" 
                                min="5" max="120" step="5">
                        </div>
                        
                        <div class="sd-form-group">
                            <label class="sd-checkbox-label">
                                <input type="checkbox" id="enable-cache" 
                                    <?php echo get_option('sd_enable_cache') ? 'checked' : ''; ?>>
                                <span>Ï∫êÏã± ÌôúÏÑ±Ìôî</span>
                            </label>
                        </div>
                        
                        <div class="sd-form-group">
                            <label for="cache-duration">Ï∫êÏãú Ïú†ÏßÄ ÏãúÍ∞Ñ (Ï¥à)</label>
                            <input type="number" id="cache-duration" class="sd-input" 
                                value="<?php echo esc_attr(get_option('sd_cache_duration')); ?>" 
                                min="60" max="3600" step="60">
                            <p class="sd-help-text">Ï∫êÏãúÎêú Îç∞Ïù¥ÌÑ∞Í∞Ä Ïú†ÏßÄÎêòÎäî ÏãúÍ∞ÑÏûÖÎãàÎã§.</p>
                        </div>
                        
                        <div class="sd-form-actions">
                            <button type="button" class="sd-btn-secondary" id="clear-cache">
                                <span class="sd-icon">üóëÔ∏è</span>
                                <span>Ï∫êÏãú ÎπÑÏö∞Í∏∞</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="sd-settings-message" id="settings-message"></div>
            </div>
        </div>
        <?php
    }
    
    /**
     * ÌïÑÌÑ∞ Î™®Îã¨ Î†åÎçîÎßÅ
     */
    private function render_filter_modal() {
        ?>
        <div class="sd-modal-overlay" id="filter-modal">
            <div class="sd-modal">
                <div class="sd-modal-header">
                    <h3 class="sd-modal-title">ÌïÑÌÑ∞ ÏÑ§Ï†ï</h3>
                    <button class="sd-modal-close" id="modal-close">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                <div class="sd-modal-body">
                    <form class="sd-filter-form" id="filter-form">
                        <div class="sd-filter-group">
                            <label class="sd-filter-label" for="modal-filter-sosok">ÏÜåÏÜç</label>
                            <select id="modal-filter-sosok" class="sd-filter-select">
                                <option value="">ÏÜåÏÜç ÏÑ†ÌÉù</option>
                            </select>
                        </div>
                        <div class="sd-filter-group">
                            <label class="sd-filter-label" for="modal-filter-buseo">Î∂ÄÏÑú</label>
                            <select id="modal-filter-buseo" class="sd-filter-select" disabled>
                                <option value="">Î∂ÄÏÑú ÏÑ†ÌÉù</option>
                            </select>
                        </div>
                        <div class="sd-filter-group">
                            <label class="sd-filter-label" for="modal-filter-site">ÌòÑÏû•</label>
                            <select id="modal-filter-site" class="sd-filter-select" disabled>
                                <option value="">ÌòÑÏû• ÏÑ†ÌÉù</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="sd-modal-footer">
                    <button type="button" class="sd-btn-secondary" id="modal-reset">Ï¥àÍ∏∞Ìôî</button>
                    <div class="sd-modal-actions">
                        <button type="button" class="sd-btn-secondary" id="modal-cancel">Ï∑®ÏÜå</button>
                        <button type="button" class="sd-btn-primary" id="modal-apply">Ï†ÅÏö©</button>
                    </div>
                </div>
            </div>
        </div>
        <?php
    }
    
    /**
     * Ïù∏ÎùºÏù∏ Ï¥àÍ∏∞Ìôî Ïä§ÌÅ¨Î¶ΩÌä∏
     */
    private function render_inline_script() {
        ?>
        <script>
        jQuery(document).ready(function($) {
            console.log('Inline script ready');
            
            // Load organization data immediately
            let organizationData = {};
            
            $.ajax({
                url: '<?php echo admin_url('admin-ajax.php'); ?>',
                type: 'POST',
                data: {
                    action: 'sd_get_organization_data',
                    nonce: '<?php echo wp_create_nonce('sd_ajax_nonce'); ?>'
                },
                success: function(response) {
                    if (response.success) {
                        organizationData = response.data;
                        console.log('Organization data loaded (inline):', organizationData);
                        
                        // Populate sosok options
                        const $sosokSelect = $('#modal-filter-sosok');
                        $sosokSelect.empty();
                        $sosokSelect.append('<option value="">ÏÜåÏÜç ÏÑ†ÌÉù</option>');
                        
                        Object.keys(organizationData).forEach(function(sosok) {
                            $sosokSelect.append('<option value="' + sosok + '">' + sosok + '</option>');
                        });
                    }
                }
            });
            
            // Filter button event binding
            $(document).on('click', '#overview-filter-btn, #storage-filter-btn', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Filter button clicked (inline)');
                
                // Show modal directly
                const $modal = $('#filter-modal');
                $modal.addClass('active');
                setTimeout(function() {
                    $modal.addClass('show');
                }, 10);
            });
            
            // Modal close
            $(document).on('click', '#modal-close, #modal-cancel', function(e) {
                e.preventDefault();
                const $modal = $('#filter-modal');
                $modal.removeClass('show');
                setTimeout(function() {
                    $modal.removeClass('active');
                }, 300);
            });
            
            // Modal overlay click to close
            $(document).on('click', '#filter-modal', function(e) {
                if (e.target === this) {
                    $(this).removeClass('show');
                    setTimeout(() => {
                        $(this).removeClass('active');
                    }, 300);
                }
            });
            
            // Sosok change handler
            $(document).on('change', '#modal-filter-sosok', function() {
                const sosok = $(this).val();
                console.log('Sosok changed to:', sosok);
                
                const $buseoSelect = $('#modal-filter-buseo');
                const $siteSelect = $('#modal-filter-site');
                
                // Reset buseo and site
                $buseoSelect.empty().append('<option value="">Î∂ÄÏÑú ÏÑ†ÌÉù</option>').prop('disabled', true);
                $siteSelect.empty().append('<option value="">ÌòÑÏû• ÏÑ†ÌÉù</option>').prop('disabled', true);
                
                if (sosok && organizationData[sosok]) {
                    console.log('Buseo data for', sosok, ':', organizationData[sosok]);
                    $buseoSelect.prop('disabled', false);
                    
                    Object.keys(organizationData[sosok]).forEach(function(buseo) {
                        $buseoSelect.append('<option value="' + buseo + '">' + buseo + '</option>');
                    });
                }
            });
            
            // Buseo change handler
            $(document).on('change', '#modal-filter-buseo', function() {
                const sosok = $('#modal-filter-sosok').val();
                const buseo = $(this).val();
                console.log('Buseo changed to:', buseo);
                
                const $siteSelect = $('#modal-filter-site');
                
                // Reset site
                $siteSelect.empty().append('<option value="">ÌòÑÏû• ÏÑ†ÌÉù</option>').prop('disabled', true);
                
                if (sosok && buseo && organizationData[sosok] && organizationData[sosok][buseo]) {
                    console.log('Site data for', buseo, ':', organizationData[sosok][buseo]);
                    $siteSelect.prop('disabled', false);
                    
                    // Add "Ï†ÑÏ≤¥ ÌòÑÏû•" option for non-admin
                    if (!(sosok === 'Í¥ÄÎ¶¨Ïûê' && buseo === 'Í¥ÄÎ¶¨Ïûê')) {
                        $siteSelect.append('<option value="' + buseo + '_Ï†ÑÏ≤¥" style="font-weight: bold; color: #0073aa;">' + buseo + ' Ï†ÑÏ≤¥ ÌòÑÏû•</option>');
                    }
                    
                    organizationData[sosok][buseo].forEach(function(site) {
                        let optionText = site;
                        if (sosok === 'Í¥ÄÎ¶¨Ïûê' && buseo === 'Í¥ÄÎ¶¨Ïûê' && site === 'Í¥ÄÎ¶¨Ïûê') {
                            optionText = 'Í¥ÄÎ¶¨Ïûê (Ï†ÑÏ≤¥ Ï†ëÍ∑º)';
                        }
                        $siteSelect.append('<option value="' + site + '">' + optionText + '</option>');
                    });
                }
            });
            
            // Apply button
            $(document).on('click', '#modal-apply', function(e) {
                e.preventDefault();
                console.log('Apply button clicked');
                
                const sosok = $('#modal-filter-sosok').val();
                const buseo = $('#modal-filter-buseo').val();
                const site = $('#modal-filter-site').val();
                
                console.log('Selected filters:', sosok, buseo, site);
                
                if (!sosok || !buseo || !site) {
                    alert('Î™®Îì† ÌïÑÌÑ∞Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.');
                    return;
                }
                
                // Trigger the main JS to handle the filter application
                $(document).trigger('sd:filters-applied', {
                    sosok: sosok,
                    buseo: buseo,
                    site: site
                });
                
                // Update filter display
                $('#overview-filter-status').show();
                $('#overview-filter-text').text(sosok + ' > ' + buseo + ' > ' + site);
                $('#overview-filter-btn').addClass('active');
                
                $('#storage-filter-status').show();
                $('#storage-filter-text').text(sosok + ' > ' + buseo + ' > ' + site);
                $('#storage-filter-btn').addClass('active');
                
                // Update global state if available
                if (window.sdState) {
                    window.sdState.filters = {
                        sosok: sosok,
                        buseo: buseo,
                        site: site
                    };
                }
                
                // Close modal
                const $modal = $('#filter-modal');
                console.log('Closing modal...');
                
                // Remove classes and hide directly
                $modal.removeClass('show active');
                $modal.css('display', 'none');
                
                // Re-enable display after animation
                setTimeout(function() {
                    $modal.css('display', '');
                    console.log('Modal closed');
                }, 500);
            });
            
            // Reset button
            $(document).on('click', '#modal-reset', function(e) {
                e.preventDefault();
                $('#modal-filter-sosok').val('');
                $('#modal-filter-buseo').empty().append('<option value="">Î∂ÄÏÑú ÏÑ†ÌÉù</option>').prop('disabled', true);
                $('#modal-filter-site').empty().append('<option value="">ÌòÑÏû• ÏÑ†ÌÉù</option>').prop('disabled', true);
            });
            
            // Check if elements exist
            console.log('Filter buttons found:', $('#overview-filter-btn').length, $('#storage-filter-btn').length);
            console.log('Modal found:', $('#filter-modal').length);
        });
        </script>
        <?php
    }
}