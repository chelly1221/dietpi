<?php
/**
 * Google Themed Menu - Core Functionality
 * 
 * ÌîåÎü¨Í∑∏Ïù∏Ïùò ÌïµÏã¨ Í∏∞Îä•ÏùÑ Îã¥ÎãπÌïòÎäî ÌÅ¥ÎûòÏä§
 * Îç∞Ïù¥ÌÑ∞ Í¥ÄÎ¶¨, Í∂åÌïú ÌôïÏù∏, AJAX Ï≤òÎ¶¨ Îì±
 */

// ÏßÅÏ†ë Ï†ëÍ∑º Î∞©ÏßÄ
if (!defined('ABSPATH')) {
    exit;
}

class GTM_Core {
    
    private static $instance = null;
    protected $menu_items = array();
    protected $permissions = array();
    protected $access_settings = array();
    protected $login_settings = array();
    
    public static function get_instance() {
        if (null === self::$instance) {
            self::$instance = new self();
        }
        return self::$instance;
    }
    
    private function __construct() {
        $this->load_options();
        $this->init_hooks();
    }
    
    /**
     * ÌîåÎü¨Í∑∏Ïù∏ ÌôúÏÑ±Ìôî
     */
    public static function activate() {
        // ÏäπÏù∏Ïûê Ïó≠Ìï† ÏÉùÏÑ±
        if (!get_role('approver')) {
            add_role('approver', 'ÏäπÏù∏Ïûê', array(
                'read' => true,
                'edit_posts' => false,
                'delete_posts' => false,
            ));
        }
        
        // Í∏∞Î≥∏ ÏòµÏÖò ÏÑ§Ï†ï - Í∏∞Ï°¥ ÏòµÏÖòÏù¥ ÏóÜÏùÑ ÎïåÎßå ÏÑ§Ï†ï
        if (get_option('gtm_menu_items') === false) {
            update_option('gtm_menu_items', self::get_default_menu_items());
        }
        
        if (get_option('gtm_menu_permissions') === false) {
            $default_permissions = array();
            foreach (self::get_default_menu_items() as $item) {
                // Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï: Ï±óÎ¥áÍ≥º Í≥µÏßÄÏÇ¨Ìï≠ÏùÄ Î™®Îì† ÏÇ¨Ïö©Ïûê(guest), ÎÇòÎ®∏ÏßÄÎäî Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©Ïûê(all)
                if ($item['id'] === 'chatbot' || $item['id'] === 'notice') {
                    $default_permissions[$item['id']] = array('guest');
                } else {
                    $default_permissions[$item['id']] = array('all');
                }
            }
            update_option('gtm_menu_permissions', $default_permissions);
        }
        
        if (get_option('gtm_access_settings') === false) {
            update_option('gtm_access_settings', self::get_default_access_settings());
        }
        
        if (get_option('gtm_login_settings') === false) {
            update_option('gtm_login_settings', self::get_default_login_settings());
        }
        
        // ÌîåÎü¨Í∑∏Ïù∏ Î≤ÑÏ†Ñ Ï†ÄÏû•
        update_option('gtm_version', GTM_VERSION);
    }
    
    /**
     * ÌîåÎü¨Í∑∏Ïù∏ ÎπÑÌôúÏÑ±Ìôî
     */
    public static function deactivate() {
        // ÌïÑÏöîÌïú Ï†ïÎ¶¨ ÏûëÏóÖ
    }
    
    /**
     * ÏòµÏÖò Î°úÎìú
     */
    protected function load_options() {
        // ÏòµÏÖòÏùÑ Î∂àÎü¨Ïò¨ Îïå Í∏∞Î≥∏Í∞íÍ≥º Î≥ëÌï©ÌïòÏßÄ ÏïäÍ≥† Ï†ÄÏû•Îêú Í∞íÎßå ÏÇ¨Ïö©
        $this->menu_items = get_option('gtm_menu_items', array());
        $this->permissions = get_option('gtm_menu_permissions', array());
        $this->access_settings = get_option('gtm_access_settings', array());
        $this->login_settings = get_option('gtm_login_settings', array());
        
        // Ï≤´ ÏÑ§Ïπò ÏãúÏóêÎßå Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        if (empty($this->menu_items)) {
            $this->menu_items = $this->get_default_menu_items();
            update_option('gtm_menu_items', $this->menu_items);
        }
        
        if (empty($this->permissions)) {
            $default_permissions = array();
            foreach ($this->menu_items as $item) {
                if ($item['id'] === 'chatbot' || $item['id'] === 'notice') {
                    $default_permissions[$item['id']] = array('guest');
                } else {
                    $default_permissions[$item['id']] = array('all');
                }
            }
            $this->permissions = $default_permissions;
            update_option('gtm_menu_permissions', $this->permissions);
        }
        
        if (empty($this->access_settings)) {
            $this->access_settings = $this->get_default_access_settings();
            update_option('gtm_access_settings', $this->access_settings);
        }
        
        if (empty($this->login_settings)) {
            $this->login_settings = $this->get_default_login_settings();
            update_option('gtm_login_settings', $this->login_settings);
        }
        
        // Í∂åÌïú Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù (ÏàòÏ†ïÌïòÏßÄ ÏïäÍ≥† Í≤ÄÏ¶ùÎßå)
        $this->validate_permissions(false);
    }
    
    /**
     * Í∂åÌïú Îç∞Ïù¥ÌÑ∞ Í≤ÄÏ¶ù
     */
    protected function validate_permissions($save = true) {
        $updated = false;
        
        foreach ($this->permissions as $menu_id => &$perms) {
            // Î∞∞Ïó¥Ïù¥ ÏïÑÎãå Í≤ΩÏö∞ Î∞∞Ïó¥Î°ú Î≥ÄÌôò
            if (!is_array($perms)) {
                $perms = array($perms);
                $updated = true;
            }
            
            // guestÍ∞Ä ÏûàÏúºÎ©¥ guestÎßå ÎÇ®Í∏∞Í∏∞ (Ï§ëÎ≥µ Ï†úÍ±∞)
            if (in_array('guest', $perms) && count($perms) > 1) {
                $perms = array('guest');
                $updated = true;
            }
        }
        
        if ($updated && $save) {
            update_option('gtm_menu_permissions', $this->permissions);
        }
    }
    
    /**
     * ÌõÖ Ï¥àÍ∏∞Ìôî
     */
    protected function init_hooks() {
        add_action('init', array($this, 'init'));
        
        // ÏäπÏù∏Ïûê Ïó≠Ìï† Í¥ÄÎ†®
        add_action('after_setup_theme', array($this, 'hide_admin_bar_for_approver'));
        
        // Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨
        add_action('init', array($this, 'handle_logout'));
        add_action('wp_logout', array($this, 'redirect_after_logout'));
        
        // Î°úÍ∑∏Ïù∏ Î¶¨Îã§Ïù¥Î†âÌä∏
        add_filter('login_redirect', array($this, 'custom_login_redirect'), 10, 3);
        
        // AJAX Ï≤òÎ¶¨
        add_action('wp_ajax_gtm_get_menu_html', array($this, 'ajax_get_menu_html'));
        add_action('wp_ajax_nopriv_gtm_get_menu_html', array($this, 'ajax_get_menu_html'));
    }
    
    /**
     * Ï¥àÍ∏∞Ìôî
     */
    public function init() {
        // ÏäπÏù∏Ïûê Ïó≠Ìï† ÌôïÏù∏ Î∞è ÏÉùÏÑ±
        if (!get_role('approver')) {
            add_role('approver', 'ÏäπÏù∏Ïûê', array(
                'read' => true,
                'edit_posts' => false,
                'delete_posts' => false,
            ));
        }
    }
    
    /**
     * Í∏∞Î≥∏ Î©îÎâ¥ Ìï≠Î™©
     */
    public static function get_default_menu_items() {
        return array(
            array(
                'id' => 'chatbot',
                'icon' => 'üîç',
                'text' => 'Ï±óÎ¥á',
                'url' => '/',
                'order' => 1,
                'guest_action' => 'allow',
                'no_permission_action' => 'show_message',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            ),
            array(
                'id' => 'documents',
                'icon' => 'üìÅ',
                'text' => 'Î¨∏ÏÑúÍ¥ÄÎ¶¨',
                'url' => '/?page_id=96',
                'order' => 2,
                'guest_action' => 'redirect_login',
                'no_permission_action' => 'show_message',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            ),
            array(
                'id' => 'facility',
                'icon' => '‚öôÔ∏è',
                'text' => 'ÏãúÏÑ§Ï†ïÏùò',
                'url' => '/?page_id=439',
                'order' => 3,
                'guest_action' => 'redirect_login',
                'no_permission_action' => 'show_message',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            ),
            array(
                'id' => 'notice',
                'icon' => 'üìù',
                'text' => 'Í≥µÏßÄÏÇ¨Ìï≠',
                'url' => '/?page_id=292',
                'order' => 4,
                'guest_action' => 'allow',
                'no_permission_action' => 'show_message',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            ),
            array(
                'id' => 'approve',
                'icon' => '‚úÖ',
                'text' => 'Í≥ÑÏ†ïÏäπÏù∏',
                'url' => '/?page_id=578',
                'order' => 5,
                'guest_action' => 'redirect_login',
                'no_permission_action' => 'redirect_home',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            ),
            array(
                'id' => 'admin',
                'icon' => '‚öôÔ∏è',
                'text' => 'Î©îÎâ¥Í¥ÄÎ¶¨',
                'url' => '/?page_id=999', // Î©îÎâ¥ Í¥ÄÎ¶¨ ÌéòÏù¥ÏßÄ IDÎ°ú Î≥ÄÍ≤Ω ÌïÑÏöî
                'order' => 6,
                'guest_action' => 'redirect_login',
                'no_permission_action' => 'redirect_home',
                'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
                'no_permission_redirect' => '/'
            )
        );
    }
    
    /**
     * Í∏∞Î≥∏ Ï†ëÍ∑º ÏÑ§Ï†ï
     */
    public static function get_default_access_settings() {
        return array(
            'guest_action' => 'redirect_login',
            'no_permission_action' => 'show_message',
            'no_permission_message' => 'Ïù¥ ÌéòÏù¥ÏßÄÏóê Ï†ëÍ∑ºÌï† Í∂åÌïúÏù¥ ÏóÜÏäµÎãàÎã§.',
            'no_permission_redirect' => '/'
        );
    }
    
    /**
     * Í∏∞Î≥∏ Î°úÍ∑∏Ïù∏ ÏÑ§Ï†ï
     */
    public static function get_default_login_settings() {
        return array(
            'login_page_id' => '559',
            'logout_redirect' => '/',
            'login_redirect' => 'previous_page',
            'custom_login_redirect' => ''
        );
    }
    
    /**
     * ÏÇ¨Ïö©ÏûêÍ∞Ä Î©îÎâ¥Î•º Î≥º Ïàò ÏûàÎäîÏßÄ ÌôïÏù∏
     */
    public function user_can_see_menu($menu_id) {
        // Í∂åÌïú ÏÑ§Ï†ïÏù¥ ÏóÜÏúºÎ©¥ Î°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÏóêÍ≤åÎßå ÌóàÏö© (Î≥¥ÏïàÏÉÅ ÏïàÏ†ÑÌïú Í∏∞Î≥∏Í∞í)
        if (!isset($this->permissions[$menu_id]) || empty($this->permissions[$menu_id])) {
            error_log('GTM Debug - No permissions set for menu: ' . $menu_id . ', defaulting to logged in users only');
            return is_user_logged_in();
        }
        
        $allowed_roles = $this->permissions[$menu_id];
        if (!is_array($allowed_roles)) {
            error_log('GTM Debug - Invalid permissions format for menu: ' . $menu_id);
            return is_user_logged_in();
        }
        
        error_log('GTM Debug - Checking permissions for menu: ' . $menu_id . ', allowed roles: ' . print_r($allowed_roles, true));
        
        // 'guest'Í∞Ä Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Î™®Îì† ÏÇ¨Ïö©Ïûê(Î°úÍ∑∏Ïù∏/ÎπÑÎ°úÍ∑∏Ïù∏) ÌóàÏö©
        if (in_array('guest', $allowed_roles)) {
            error_log('GTM Debug - Menu allows all users (guest permission)');
            return true;
        }
        
        // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏù∏ Í≤ΩÏö∞
        if (is_user_logged_in()) {
            // 'all'Ïù¥ Ìè¨Ìï®ÎêòÏñ¥ ÏûàÏúºÎ©¥ Î°úÍ∑∏Ïù∏Ìïú Î™®Îì† ÏÇ¨Ïö©Ïûê ÌóàÏö©
            if (in_array('all', $allowed_roles)) {
                error_log('GTM Debug - Menu allows all logged in users');
                return true;
            }
            
            // ÌäπÏ†ï Ïó≠Ìï† Ï≤¥ÌÅ¨
            $user = wp_get_current_user();
            if ($user && isset($user->roles) && is_array($user->roles)) {
                foreach ($user->roles as $role) {
                    if (in_array($role, $allowed_roles)) {
                        error_log('GTM Debug - User role ' . $role . ' is allowed');
                        return true;
                    }
                }
                error_log('GTM Debug - User roles (' . implode(', ', $user->roles) . ') not in allowed list');
            }
        } else {
            error_log('GTM Debug - Guest user and no guest permission');
        }
        
        return false;
    }
    
    /**
     * Î°úÍ∑∏Ïù∏ URL Í∞ÄÏ†∏Ïò§Í∏∞
     */
    public function get_login_url() {
        $login_page_id = isset($this->login_settings['login_page_id']) ? $this->login_settings['login_page_id'] : '559';
        return get_permalink($login_page_id) ?: '/?page_id=' . $login_page_id;
    }
    
    /**
     * Î°úÍ∑∏ÏïÑÏõÉ URL Í∞ÄÏ†∏Ïò§Í∏∞
     */
    public function get_logout_url() {
        return add_query_arg('do_custom_logout', '1', home_url('/'));
    }
    
    /**
     * Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨
     */
    public function handle_logout() {
        if (isset($_GET['do_custom_logout']) && $_GET['do_custom_logout'] == '1') {
            wp_logout();
            $redirect = isset($this->login_settings['logout_redirect']) ? $this->login_settings['logout_redirect'] : '/';
            wp_redirect(home_url($redirect));
            exit;
        }
    }
    
    /**
     * Î°úÍ∑∏ÏïÑÏõÉ ÌõÑ Î¶¨Îã§Ïù¥Î†âÌä∏
     */
    public function redirect_after_logout() {
        $redirect = isset($this->login_settings['logout_redirect']) ? $this->login_settings['logout_redirect'] : '/';
        wp_redirect(home_url($redirect));
        exit;
    }
    
    /**
     * Î°úÍ∑∏Ïù∏ Î¶¨Îã§Ïù¥Î†âÌä∏ Ïª§Ïä§ÌÑ∞ÎßàÏù¥Ïßï
     */
    public function custom_login_redirect($redirect_to, $request, $user) {
        if (isset($user->roles) && is_array($user->roles)) {
            $redirect_type = isset($this->login_settings['login_redirect']) ? $this->login_settings['login_redirect'] : 'previous_page';
            
            if ($redirect_type === 'previous_page' && !empty($request)) {
                return $request;
            } elseif ($redirect_type === 'custom' && !empty($this->login_settings['custom_login_redirect'])) {
                return home_url($this->login_settings['custom_login_redirect']);
            }
        }
        
        return $redirect_to;
    }
    
    /**
     * ÏäπÏù∏Ïûê Í¥ÄÎ¶¨ Î∞î Ïà®Í∏∞Í∏∞
     */
    public function hide_admin_bar_for_approver() {
        if (current_user_can('approver') && !current_user_can('manage_options')) {
            show_admin_bar(false);
        }
    }
    
    /**
     * AJAX: Î©îÎâ¥ HTML Í∞ÄÏ†∏Ïò§Í∏∞
     */
    public function ajax_get_menu_html() {
        $frontend = GTM_Frontend::get_instance();
        echo $frontend->get_menu_items_html();
        wp_die();
    }
    
    /**
     * Î©îÎâ¥ Ìï≠Î™© Ï†ÄÏû• (ÎÇ¥Î∂Ä ÏÇ¨Ïö©)
     */
    public function save_menu_items($menu_items) {
        update_option('gtm_menu_items', $menu_items);
        $this->menu_items = $menu_items;
    }
    
    /**
     * Í∂åÌïú Ï†ÄÏû• (ÎÇ¥Î∂Ä ÏÇ¨Ïö©)
     */
    public function save_permissions($permissions) {
        update_option('gtm_menu_permissions', $permissions);
        $this->permissions = $permissions;
    }
    
    // Getter Î©îÏÑúÎìúÎì§
    public function get_menu_items() {
        return $this->menu_items;
    }
    
    public function get_permissions() {
        return $this->permissions;
    }
    
    public function get_access_settings() {
        return $this->access_settings;
    }
    
    public function get_login_settings() {
        return $this->login_settings;
    }
}