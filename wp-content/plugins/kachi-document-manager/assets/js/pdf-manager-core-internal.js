/**
 * 3chan PDF Manager - Core Functions (Internal Network Version)
 * ÎÇ¥Î∂ÄÎßù Ï†ÑÏö© Î≤ÑÏ†Ñ - ÌîÑÎ°ùÏãú Î™®ÎìúÎßå ÏÇ¨Ïö©
 * ÌÉÄÏûÑÏïÑÏõÉ Î¨∏Ï†ú Ìï¥Í≤∞ Î≤ÑÏ†Ñ
 * Ïù¥ÎØ∏ÏßÄ URLÏùÄ Ï†ÄÏû•ÌïòÏßÄ ÏïäÍ≥† ÌëúÏãúÌï† ÎïåÎßå ÌîÑÎ°ùÏãúÎ°ú Î≥ÄÌôò
 */

(function($) {
    'use strict';

    // Global configuration - Internal Network Only
    window.PDFManagerConfig = {
        USE_PROXY: true, // Always true for internal network
        AJAX_URL: window.threechan_pdf_ajax?.ajax_url,
        NONCE: window.threechan_pdf_ajax?.nonce,
        PLUGIN_URL: window.threechan_pdf_ajax?.plugin_url,
        INTERNAL_NETWORK_ONLY: true,
        // ÌÉÄÏûÑÏïÑÏõÉ ÏÑ§Ï†ï Ï∂îÍ∞Ä
        UPLOAD_TIMEOUT: 300000, // 5Î∂Ñ (ÌååÏùº ÏóÖÎ°úÎìúÏö©)
        DEFAULT_TIMEOUT: 30000  // 30Ï¥à (ÏùºÎ∞ò ÏöîÏ≤≠Ïö©)
    };

    // Global state
    window.PDFManagerState = {
        // File management variables
        allFiles: [],
        filteredFiles: [],
        currentPage: 1,
        pageSize: 10,
        selectedTags: [],
        tagFilterEnabled: false,
        currentPopupFileId: null,
        currentPopupPageNumber: 1
    };

    // Core API request function - Internal Network Version with Timeout Fix
    window.PDFManagerAPI = {
        request: async function(endpoint, options = {}) {
            const config = window.PDFManagerConfig;
            
            // Always use WordPress AJAX proxy for internal network
            const formData = new FormData();
            formData.append('action', '3chan_proxy_api');
            formData.append('nonce', config.NONCE);
            
            let finalEndpoint = endpoint;
            
            // Handle query parameters
            if (options.params) {
                const params = new URLSearchParams();
                Object.entries(options.params).forEach(([key, value]) => {
                    if (Array.isArray(value)) {
                        value.forEach(v => params.append(key, v));
                    } else if (value !== null && value !== undefined) {
                        params.append(key, value);
                    }
                });
                if (params.toString()) {
                    const separator = finalEndpoint.includes('?') ? '&' : '?';
                    finalEndpoint = finalEndpoint + separator + params.toString();
                }
            }
            
            formData.append('endpoint', finalEndpoint);
            
            if (options.method) {
                formData.append('method', options.method);
            }

            // Handle form data
            if (options.body instanceof FormData) {
                for (let [key, value] of options.body.entries()) {
                    if (key !== 'action' && key !== 'nonce' && key !== 'endpoint' && key !== 'method') {
                        formData.append(key, value);
                    }
                }
            }

            // Determine timeout based on endpoint
            let timeout = config.DEFAULT_TIMEOUT;
            
            // For upload endpoints, use longer timeout
            if (finalEndpoint.includes('upload-async') || finalEndpoint.includes('upload-pdf')) {
                timeout = config.UPLOAD_TIMEOUT;
                console.log(`‚è±Ô∏è Using extended timeout for upload: ${timeout}ms`);
            }
            
            // For async upload, we expect quick response (just task creation)
            if (finalEndpoint.includes('upload-async')) {
                timeout = 60000; // 60 seconds should be enough for creating tasks
                console.log(`‚è±Ô∏è Using async upload timeout: ${timeout}ms`);
            }

            try {
                // Create AbortController for timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                    console.error(`‚è±Ô∏è Request timeout after ${timeout}ms for: ${finalEndpoint}`);
                }, timeout);

                const response = await fetch(config.AJAX_URL, {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin',
                    signal: controller.signal
                }).finally(() => {
                    clearTimeout(timeoutId);
                });

                // Check if we're being blocked by external network
                if (!response.ok && response.status === 403) {
                    const text = await response.text();
                    if (text.includes('External network')) {
                        throw new Error('Ïô∏Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨ÏóêÏÑúÎäî Ï†ëÍ∑ºÌï† Ïàò ÏóÜÏäµÎãàÎã§.');
                    }
                }

                // For async upload, check if we got a WordPress AJAX error response
                if (finalEndpoint.includes('upload-async')) {
                    const clonedResponse = response.clone();
                    try {
                        const text = await clonedResponse.text();
                        const jsonData = JSON.parse(text);
                        
                        // Check if WordPress AJAX returned an error
                        if (jsonData.success === false) {
                            console.error('WordPress AJAX Error:', jsonData.data);
                            
                            // If it's a timeout error, create a mock success response
                            if (jsonData.data?.error?.includes('timed out') || 
                                jsonData.data?.error?.includes('timeout')) {
                                console.log('‚ö†Ô∏è Upload request timed out, but files might be processing');
                                
                                // Return a mock successful response
                                // The files are likely uploaded and being processed
                                const mockResponse = new Response(JSON.stringify({
                                    status: 'accepted',
                                    task_ids: ['timeout-unknown'],
                                    message: 'ÌååÏùº ÏóÖÎ°úÎìúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Ï≤òÎ¶¨ ÏÉÅÌÉúÎäî ÏûëÏóÖ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.'
                                }), {
                                    status: 200,
                                    headers: { 'Content-Type': 'application/json' }
                                });
                                return mockResponse;
                            }
                        }
                    } catch (e) {
                        // If JSON parsing fails, return original response
                        console.log('Response is not JSON, returning as-is');
                    }
                }

                return response;
                
            } catch (error) {
                // Handle timeout errors specially for upload-async
                if (error.name === 'AbortError' && finalEndpoint.includes('upload-async')) {
                    console.warn('‚ö†Ô∏è Upload request timed out, assuming success');
                    
                    // Return a mock successful response for timeout
                    return new Response(JSON.stringify({
                        status: 'accepted',
                        task_ids: ['timeout-unknown'],
                        message: 'ÌååÏùº ÏóÖÎ°úÎìúÍ∞Ä ÏãúÏûëÎêòÏóàÏäµÎãàÎã§. Ï≤òÎ¶¨ ÏÉÅÌÉúÎäî ÏûëÏóÖ Î™©Î°ùÏóêÏÑú ÌôïÏù∏ÌïòÏÑ∏Ïöî.'
                    }), {
                        status: 200,
                        headers: { 'Content-Type': 'application/json' }
                    });
                }
                
                console.error('API Request Error:', error);
                throw error;
            }
        }
    };

    // Content processing utilities - ÌëúÏãú Ï†ÑÏö©, ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏùå
    window.PDFManagerUtils = {
        // Process image URLs in content to use proxy - ÌëúÏãú Ï†ÑÏö©
        processImageUrlsForDisplay: function(content) {
            if (!content) return content;
            
            // ÏõêÎ≥∏ contentÏùò Î≥µÏÇ¨Î≥∏ÏùÑ ÎßåÎì§Ïñ¥ Ï≤òÎ¶¨
            let displayContent = content;
            
            // Regular expression to find image URLs with :8001/image pattern
            const imageUrlPattern = /(https?:\/\/[^:]+):8001\/image([^"'\s>]+)/g;
            
            // Replace image URLs with HTML img tags using proxy URLs for display only
            displayContent = displayContent.replace(imageUrlPattern, (match, baseUrl, imagePath) => {
                // Create proxy URL for display
                const proxyUrl = this.createProxyImageUrl(baseUrl + ':8001/image' + imagePath);
                console.log('üñºÔ∏è Converting image URL to HTML img tag:', match, '‚Üí', proxyUrl);
                return `<img src="${proxyUrl}" alt="Document Image" style="max-width: 100%; height: auto; display: block; margin: 10px 0; border: 1px solid #ddd; border-radius: 4px;" loading="lazy" onerror="this.style.display='none'; console.warn('Failed to load image:', '${proxyUrl}');">`;
            });
            
            // Also handle img tags with src attributes
            displayContent = displayContent.replace(/<img([^>]+)src=["']([^"']+:8001\/image[^"']+)["']([^>]*)>/gi, (match, before, imageUrl, after) => {
                const proxyUrl = this.createProxyImageUrl(imageUrl);
                return `<img${before}src="${proxyUrl}"${after}>`;
            });
            
            return displayContent;
        },

        // Create proxy URL for images
        createProxyImageUrl: function(originalUrl) {
            const config = window.PDFManagerConfig;
            
            // Create FormData for proxy request
            const params = new URLSearchParams({
                action: '3chan_proxy_image',
                nonce: config.NONCE,
                image_url: originalUrl
            });
            
            // Return the proxy URL
            return config.AJAX_URL + '?' + params.toString();
        },

        // Process and format content for display - Ïù¥ÎØ∏ÏßÄ URL Î≥ÄÌôò Ï†úÍ±∞
        processContent: function(content) {
            if (!content) return '';
            
            // Ïù¥ÎØ∏ÏßÄ URL Ï≤òÎ¶¨Îäî Î≥ÑÎèÑ Ìï®ÏàòÏóêÏÑú Ï≤òÎ¶¨ÌïòÎØÄÎ°ú Ïó¨Í∏∞ÏÑúÎäî Ï†úÍ±∞
            // ÏùºÎ∞òÏ†ÅÏù∏ ÏΩòÌÖêÏ∏† Ìè¨Îß∑ÌåÖÎßå Ï≤òÎ¶¨
            
            // Replace newlines with proper line breaks
            let processedContent = content.replace(/\n/g, '<br>');
            
            // Process special arrow symbols with line breaks BEFORE them
            processedContent = processedContent.replace(/([^>])([‚ñ∂‚ñ∑‚ñ∫‚Üí‚áí‚ûú‚û°‚û§])/g, '$1<br>$2');
            
            // Process numbered lists
            processedContent = processedContent.replace(/^(\d+)\.\s+(.*)$/gm, '<div class="list-item numbered"><span class="list-number">$1.</span><span class="list-content">$2</span></div>');
            
            // Process bullet points
            processedContent = processedContent.replace(/^[-‚Ä¢¬∑‚ñ†‚ñ°‚ñ™‚ñ´‚óÜ‚óá‚óã‚óå]\s+(.*)$/gm, '<div class="list-item bullet"><span class="list-bullet">‚Ä¢</span><span class="list-content">$1</span></div>');
            
            // Process Korean bullet points
            processedContent = processedContent.replace(/^([Í∞Ä-Ìû£])\.\s+(.*)$/gm, '<div class="list-item korean"><span class="list-korean">$1.</span><span class="list-content">$2</span></div>');
            
            // Process alphabetical lists
            processedContent = processedContent.replace(/^([a-zA-Z])\.\s+(.*)$/gm, '<div class="list-item alpha"><span class="list-alpha">$1.</span><span class="list-content">$2</span></div>');
            
            // Process Roman numerals
            processedContent = processedContent.replace(/^([ivxIVX]+)\.\s+(.*)$/gm, '<div class="list-item roman"><span class="list-roman">$1.</span><span class="list-content">$2</span></div>');
            
            // Process sub-items with indentation
            processedContent = processedContent.replace(/^(\s{2,})[-‚Ä¢¬∑‚ñ†‚ñ°‚ñ™‚ñ´‚óÜ‚óá‚óã‚óå]\s+(.*)$/gm, function(match, spaces, content) {
                const level = Math.floor(spaces.length / 2);
                return `<div class="list-item bullet level-${level}"><span class="list-bullet">‚Ä¢</span><span class="list-content">${content}</span></div>`;
            });
            
            // Process special markers
            processedContent = processedContent.replace(/^([‚Äª‚òÖ‚òÜ‚úì‚úî‚úó‚úò‚ö†Ô∏èüìåüìçüî¥üîµ])\s+(.*)$/gm, '<div class="list-item special"><span class="list-special">$1</span><span class="list-content">$2</span></div>');
            
            // Process tables
            const lines = processedContent.split('<br>');
            let inTable = false;
            let tableContent = [];
            let processedLines = [];
            
            for (let line of lines) {
                if (line.includes('|') && line.split('|').length > 2) {
                    if (!inTable) {
                        inTable = true;
                        tableContent = [];
                    }
                    tableContent.push(line);
                } else {
                    if (inTable) {
                        processedLines.push(this.formatTable(tableContent));
                        inTable = false;
                        tableContent = [];
                    }
                    processedLines.push(line);
                }
            }
            
            if (inTable && tableContent.length > 0) {
                processedLines.push(this.formatTable(tableContent));
            }
            
            processedContent = processedLines.join('<br>');
            
            // Process references
            processedContent = processedContent.replace(/\[Í∑∏Î¶º\s*(\d+)\]/g, '<div class="figure-ref">[Í∑∏Î¶º $1]</div>');
            processedContent = processedContent.replace(/\[Ìëú\s*(\d+)\]/g, '<div class="table-ref">[Ìëú $1]</div>');
            processedContent = processedContent.replace(/\[Figure\s*(\d+)\]/gi, '<div class="figure-ref">[Figure $1]</div>');
            processedContent = processedContent.replace(/\[Table\s*(\d+)\]/gi, '<div class="table-ref">[Table $1]</div>');
            
            // Clean up excessive line breaks
            processedContent = processedContent.replace(/(<br>){3,}/g, '<br><br>');
            
            // Add paragraph spacing
            processedContent = processedContent.replace(/(<br>){2}/g, '</p><p class="content-paragraph">');
            
            // Wrap in paragraph if needed
            if (!processedContent.startsWith('<p') && !processedContent.startsWith('<div')) {
                processedContent = '<p class="content-paragraph">' + processedContent + '</p>';
            }
            
            return processedContent;
        },

        // Format simple tables
        formatTable: function(tableLines) {
            if (!tableLines || tableLines.length === 0) return '';
            
            let tableHtml = '<div class="simple-table-wrapper"><table class="simple-table">';
            let isHeader = true;
            
            for (let line of tableLines) {
                const cells = line.split('|').map(cell => cell.trim()).filter(cell => cell);
                
                if (cells.length > 0) {
                    tableHtml += '<tr>';
                    
                    cells.forEach(cell => {
                        if (isHeader) {
                            tableHtml += `<th>${cell}</th>`;
                        } else {
                            tableHtml += `<td>${cell}</td>`;
                        }
                    });
                    
                    tableHtml += '</tr>';
                    
                    if (isHeader && !line.match(/^[\s|‚Äî-]+$/)) {
                        isHeader = false;
                    }
                }
            }
            
            tableHtml += '</table></div>';
            return tableHtml;
        },

        // Update document count
        updateDocumentCount: function() {
            const count = window.PDFManagerState.allFiles.length;
            const countEl = document.getElementById('documentCount');
            if (countEl) {
                countEl.textContent = `Ï¥ù ${count}Í∞ú`;
            }
        },

        // Show enhanced loading animation
        showLoadingAnimation: function() {
            const listEl = document.getElementById("storedFilesList_manage");
            if (!listEl) return;
            
            listEl.innerHTML = `
                <div class="document-list-loading">
                    <div class="loading-container">
                        <div class="folder-loading-icon">
                            <div class="folder-icon-base"></div>
                            <div class="paper paper-1"></div>
                            <div class="paper paper-2"></div>
                            <div class="paper paper-3"></div>
                        </div>
                        <div class="loading-text-animated">
                            Î¨∏ÏÑú Î™©Î°ùÏùÑ Î∂àÎü¨Ïò§Îäî Ï§ë<span class="loading-dots"></span>
                        </div>
                        <div class="loading-progress">
                            <div class="loading-progress-bar"></div>
                        </div>
                    </div>
                </div>
            `;
        },

        // Show error for external network access
        showExternalNetworkError: function() {
            const container = document.querySelector('.pdf-manager-main');
            if (container) {
                container.innerHTML = `
                    <div class="external-network-error">
                        <div class="error-icon">üö´</div>
                        <h2>Ïô∏Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨ Ï†ëÍ∑º Ï∞®Îã®</h2>
                        <p>Ïù¥ ÏãúÏä§ÌÖúÏùÄ ÎÇ¥Î∂ÄÎßùÏóêÏÑúÎßå ÏÇ¨Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§.</p>
                        <p>ÌöåÏÇ¨ ÎÇ¥Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨ÏóêÏÑú Ï†ëÏÜçÌï¥Ï£ºÏÑ∏Ïöî.</p>
                    </div>
                `;
            }
        }
    };

    // Main initialization
    $(document).ready(function() {
        console.log("‚úÖ 3chan PDF Manager Core (Internal Network) Ï§ÄÎπÑ ÏôÑÎ£å!");
        console.log("üîê ÎÇ¥Î∂ÄÎßù Ï†ÑÏö© Î™®Îìú ÌôúÏÑ±Ìôî");
        console.log("‚è±Ô∏è Upload timeout:", window.PDFManagerConfig.UPLOAD_TIMEOUT, "ms");
        console.log("‚è±Ô∏è Default timeout:", window.PDFManagerConfig.DEFAULT_TIMEOUT, "ms");
        
        const config = window.PDFManagerConfig;
        console.log("üì° ÌîÑÎ°ùÏãú ÏÇ¨Ïö©: Í∞ïÏ†ú ÌôúÏÑ±Ìôî (ÎÇ¥Î∂ÄÎßù Ï†ÑÏö©)");
        console.log("üì° AJAX URL:", config.AJAX_URL);

        // Initialize other modules
        if (window.PDFManagerUpload) {
            window.PDFManagerUpload.init();
        }
        
        if (window.PDFManagerDocuments) {
            window.PDFManagerDocuments.init();
        }

        // Auto-fetch file list and tags
        const intervalId = setInterval(() => {
            const listReady = document.getElementById("storedFilesList_manage");
            const tagBoxReady = document.getElementById("tagOptionsContainer_manage");

            if (listReady && tagBoxReady) {
                clearInterval(intervalId);
                console.log("üì• Auto-fetching file list and tags (Internal Network)...");
                if (window.PDFManagerDocuments) {
                    window.PDFManagerDocuments.fetchStoredFiles().catch(error => {
                        if (error.message && error.message.includes('Ïô∏Î∂Ä ÎÑ§Ìä∏ÏõåÌÅ¨')) {
                            window.PDFManagerUtils.showExternalNetworkError();
                        }
                    });
                    window.PDFManagerDocuments.fetchTags().catch(error => {
                        console.error('Tag fetch error:', error);
                    });
                }
            }
        }, 100);
        
        setTimeout(() => {
            clearInterval(intervalId);
        }, 10000);

        // Force toggle to OFF on load
        window.addEventListener("load", function() {
            const tagToggleInput = document.getElementById("tagToggleInput");
            if (tagToggleInput) {
                tagToggleInput.checked = false;
                if (window.PDFManagerDocuments && window.PDFManagerDocuments.toggleTagFilterMode) {
                    window.PDFManagerDocuments.toggleTagFilterMode();
                }
            }
        });

        // Add CSS for internal network indicators
        const style = document.createElement('style');
        style.textContent = `
            .external-network-error {
                text-align: center;
                padding: 100px 40px;
                background: #fff;
                border-radius: 12px;
                max-width: 500px;
                margin: 100px auto;
                box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            }
            
            .external-network-error .error-icon {
                font-size: 72px;
                margin-bottom: 20px;
            }
            
            .external-network-error h2 {
                color: #d32f2f;
                margin-bottom: 15px;
            }
            
            .external-network-error p {
                color: #666;
                line-height: 1.6;
                margin: 10px 0;
            }
            
            /* Upload timeout warning */
            .upload-timeout-warning {
                background: #fff3cd;
                border: 1px solid #ffeaa7;
                border-radius: 8px;
                padding: 12px;
                margin: 10px 0;
                color: #856404;
                font-size: 0.9rem;
            }
        `;
        document.head.appendChild(style);
    });

})(jQuery);